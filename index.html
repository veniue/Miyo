<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Miyo Phone</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="https://i.postimg.cc/bYF0NdSH/f9d3f4da6rcb3778c460a508f774d0c0.png">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <style>
        :root {
            --app-size: clamp(55px, 15vw, 62px);
            --app-radius: 14px;
            --safe-area-top: 50px;
            --safe-area-bottom: 34px;
            --wx-bg-color: #ededed; 
            --glass-bg: rgba(255, 255, 255, 0.95); 
            --glass-blur: blur(25px);
            --glass-shadow: 0 4px 20px rgba(0,0,0,0.05);
            --glass-radius: 20px;
            --chat-bubble-user: #ffffff; 
            --chat-bubble-role: #000000; 
            /* 修复：原本是 ---default-avatar-bg，多了一个横杠 */
            --default-avatar-bg: transparent; 
            --status-bar-offset: 0px;       /* 状态栏偏移量 */
            --wx-body-base-top: 175px;      /* Miyo App 内容区域的基础高度 */
        }

        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            margin: 0;
            padding: 0;
        }

        body {
            height: 100vh;
            width: 100vw;
            background-color: #ffffff;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            overflow: hidden;
            display: flex;
            justify-content: center;
        }

        /* --- 双层背景容器 --- */
        .wallpaper-container {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            width: 100%; height: 100%;
            z-index: 0;
            pointer-events: none;
        }

        .wallpaper-layer {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            will-change: opacity;
            transition: opacity 0.1s linear;
        }
        
        #bg-layer-1 { z-index: 1; }
        #bg-layer-2 { z-index: 2; opacity: 0; }

        .ui-container {
            width: 100%;
            max-width: 430px;
            height: 100%;
            position: relative;
            display: flex;
            flex-direction: column;
            z-index: 10;
            overflow: hidden; 
        }

        /* --- 桌面滑动容器 --- */
        .desktop-mask {
            flex: 1; 
            width: 100%;
            overflow: hidden;
            position: relative;
            z-index: 1;
            display: flex; 
            flex-direction: column;
        }

        .desktop-slider {
            display: flex;
            width: 200%;
            height: 100%;
            transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1);
            will-change: transform;
        }

        .desktop-page {
            width: 50%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            background: transparent;
        }

        /* --- Grid 布局系统 --- */
        .widget-board {
            width: 100%;
            padding: 60px 24px 0 24px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 155px 155px;
            gap: 20px;
            justify-items: center;
        }

        .grid-pos-top-left { grid-column: 1; grid-row: 1; }
        .grid-pos-top-right { grid-column: 2; grid-row: 1; }
        .grid-pos-bottom-left { grid-column: 1; grid-row: 2; }
        .grid-pos-bottom-right { grid-column: 2; grid-row: 2; }

        /* 双应用并排容器 */
        .app-pair {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 5px;
        }

        .ios-widget {
            border-radius: 22px;
            padding: 16px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            transition: transform 0.2s;
            width: 100%;
            height: 100%;
        }
        .ios-widget:active { transform: scale(0.96); }

        .glass-panel {
            background: rgba(255, 255, 255, 0.55);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border: 1px solid rgba(255,255,255,0.4);
            color: #000;
        }

        /* --- 黑胶唱片组件样式 --- */
        .vinyl-widget {
            background: transparent !important;
            backdrop-filter: none !important;
            border: none !important;
            box-shadow: none !important;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: visible !important; 
        }

        .vinyl-disc {
            width: 145px;
            height: 145px;
            min-width: 145px;
            min-height: 145px;
            flex-shrink: 0;
            border-radius: 50%;
            background: repeating-radial-gradient(
              #111 0, 
              #111 2px, 
              #222 3px, 
              #222 4px
            );
            box-shadow: 0 8px 20px rgba(0,0,0,0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            animation: spinRecord 8s linear infinite;
        }
        
        .vinyl-disc::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            border-radius: 50%;
            background: linear-gradient(135deg, rgba(255,255,255,0.15) 0%, transparent 50%, rgba(255,255,255,0.05) 100%);
            pointer-events: none;
        }

        .vinyl-label {
            width: 55px;
            height: 55px;
            border-radius: 50%;
            background-image: url('https://i.postimg.cc/HxkvZ5W5/ab67616d0000b27363b9845347206587071e6125.jpg');
            background-size: cover;
            background-position: center;
            border: 1px solid #333;
            z-index: 2;
        }
        
        .vinyl-hole {
            width: 8px;
            height: 8px;
            background: #000;
            border-radius: 50%;
            position: absolute;
            z-index: 3;
        }

        @keyframes spinRecord {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* --- 拍立得组件样式 --- */
        .polaroid-group {
            width: 100%;
            flex: 1; 
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding-top: 10px;
            padding-bottom: 40px; 
            gap: 15px;
            position: relative;
            z-index: 3;
        }

        .polaroid-card {
            background-color: #fff;
            padding: 5px 5px 18px 5px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            width: 28%; 
            max-width: 100px;
            aspect-ratio: 1 / 1.25; 
            transition: transform 0.2s;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .polaroid-img {
            width: 100%;
            aspect-ratio: 1/1;
            object-fit: cover;
            background-color: #eee;
            filter: contrast(1.1) saturate(0.9); 
        }

        .polaroid-1 { transform: rotate(-8deg) translateY(15px); z-index: 1; }
        .polaroid-2 { transform: rotate(2deg) scale(1.1); z-index: 2; }
        .polaroid-3 { transform: rotate(8deg) translateY(10px); z-index: 1; }

        /* --- 日历组件 --- */
        .cal-big { font-size: 38px; font-weight: 500; letter-spacing: -1px; margin-bottom: 5px; }
        .cal-day { 
            font-size: 11px; 
            font-weight: 600; 
            color: #ff3b30; 
            margin-bottom: 8px; 
            white-space: nowrap; 
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .cal-empty-text {
            font-size: 13px; 
            color: rgba(0,0,0,0.5); 
            font-weight: 500;
            line-height: 1.4;
        }

        /* --- 通用样式 --- */
        .text-light-mode { color: white !important; text-shadow: 0 1px 3px rgba(0,0,0,0.6); }
        .text-dark-mode { color: #111 !important; text-shadow: 0 0 10px rgba(255,255,255,0.8); }

        .pagination { 
            position: absolute; bottom: 125px; left: 50%; transform: translateX(-50%);
            width: auto; display: flex; justify-content: center; align-items: center;
            gap: 8px; pointer-events: none; z-index: 5; transition: all 0.3s;
            padding: 6px 14px; border-radius: 20px; backdrop-filter: blur(5px);
        }
        .dot { width: 8px; height: 8px; border-radius: 50%; transition: background-color 0.3s; }
        .pagination.text-dark-mode { background-color: rgba(0, 0, 0, 0.25); }
        .pagination.text-dark-mode .dot { background-color: rgba(0,0,0,0.4); }
        .pagination.text-dark-mode .dot.active { background-color: #000; }
        .pagination.text-light-mode { background-color: rgba(255, 255, 255, 0.25); }
        .pagination.text-light-mode .dot { background-color: rgba(255,255,255,0.4); }
        .pagination.text-light-mode .dot.active { background-color: #fff; }

        .dynamic-island {
            position: absolute; top: 11px; left: 50%; transform: translateX(-50%);
            width: 120px; height: 35px; background-color: black; border-radius: 20px;
            z-index: 2000; transition: width 0.3s, height 0.3s;
        }
        .dynamic-island:active { width: 150px; height: 45px; }

        .status-bar {
            height: var(--safe-area-top); width: 100%; position: absolute; top: 0; left: 0;
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 30px 0 30px; font-size: 15px; font-weight: 600;
            z-index: 1000; 
            background: transparent; transition: color 0.3s ease; pointer-events: none;
        }
        .status-time { width: 70px; letter-spacing: 0.5px; text-align: center; }
        .status-icons { display: flex; align-items: center; justify-content: flex-end; gap: 6px; width: 70px; }
        .status-img { height: 14px; display: block; transition: filter 0.3s ease; }
        .status-bar.light-content { color: white; }
        .status-bar.light-content .status-img { filter: invert(100%) brightness(200%); }
        .status-bar.dark-content { color: black; }
        .status-bar.dark-content .status-img { filter: invert(0%); }

        .widget-area {
            flex: 1; width: 100%; display: flex; flex-direction: column;
            justify-content: flex-start; align-items: center; padding-top: 100px; transition: color 0.3s;
        }
        .big-clock { text-align: center; color: inherit; }
        .big-time { font-size: 80px; font-weight: 600; line-height: 1; letter-spacing: -2px; }
        .big-date { font-size: 19px; font-weight: 600; margin-top: 5px; }

        .home-screen {
            padding: 0 20px 15px 20px; display: grid; grid-template-columns: repeat(4, 1fr);
            grid-template-rows: max-content; column-gap: 15px; row-gap: 20px;
            justify-items: center; width: 100%;
        }
        .app-item {
            display: flex; flex-direction: column; align-items: center; cursor: pointer;
            width: 100%; transition: transform 0.1s;
        }
        .app-item:active .app-icon { filter: brightness(0.7); transform: scale(0.92); }
        .app-icon {
            width: var(--app-size); height: var(--app-size); border-radius: var(--app-radius);
            object-fit: cover; box-shadow: 0 2px 10px rgba(0,0,0,0.15); margin-bottom: 6px;
            position: relative; display: flex; justify-content: center; align-items: center;
            font-size: 28px; color: white; background-color: transparent; 
        }
        .app-name {
            font-size: 12px; text-align: center; white-space: nowrap; overflow: hidden;
            text-overflow: ellipsis; width: 110%; transition: color 0.3s;
        }

        .dock-wrapper {
            width: 100%; padding: 0 16px 0 16px; position: relative; margin-bottom: 18px; z-index: 10;
        }
        .dock-bg {
            background: rgba(255, 255, 255, 0.2); backdrop-filter: blur(35px); -webkit-backdrop-filter: blur(35px);
            border-radius: 38px; width: 100%; height: 96px; display: flex; justify-content: space-around;
            align-items: center; padding: 0 10px; border: 1px solid rgba(255,255,255,0.1);
        }
        .dock-bg .app-name { display: none; }
        .dock-bg .app-item { width: auto; }
        .dock-bg .app-icon { margin-bottom: 0; }
        
        .home-bar-area { position: absolute; bottom: 0; left: 0; width: 100%; height: 20px; z-index: 2000; cursor: pointer; }
        .home-bar {
            position: absolute; bottom: 8px; left: 50%; transform: translateX(-50%);
            width: 135px; height: 5px; background-color: white; border-radius: 10px; z-index: 2001;
            transition: background-color 0.3s; box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        /* --- Miyo App 完整样式 --- */
        .app-window { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--wx-bg-color); z-index: 50; display: none; flex-direction: column; padding-top: var(--safe-area-top); transform-origin: center; animation: openAppAnim 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); }
        @keyframes openAppAnim { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        .wechat-header { position: absolute; top: calc(var(--safe-area-top) + var(--status-bar-offset) + 6px); left: 12px; right: 12px; height: auto; background: var(--glass-bg); backdrop-filter: var(--glass-blur); -webkit-backdrop-filter: var(--glass-blur); border-radius: var(--glass-radius); box-shadow: var(--glass-shadow); border: 1px solid rgba(255,255,255,0.3); display: flex; flex-direction: column; padding: 0 16px 8px 16px; color: #111; z-index: 101; }
        .me-top-card-container { position: absolute; top: calc(var(--safe-area-top) + var(--status-bar-offset) + 6px); left: 12px; right: 12px; height: auto; background: var(--glass-bg); backdrop-filter: var(--glass-blur); -webkit-backdrop-filter: var(--glass-blur); border-radius: var(--glass-radius); box-shadow: var(--glass-shadow); border: 1px solid rgba(255,255,255,0.3); display: none; padding: 30px 24px; align-items: center; z-index: 102; }
        
        .me-avatar { width: 64px; height: 64px; border-radius: 8px; margin-right: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); background-color: var(--default-avatar-bg); object-fit: cover; }
        .me-info { display: flex; flex-direction: column; }
        .me-nickname { font-size: 22px; font-weight: 600; margin-bottom: 6px; color: #000; }
        .me-wxid { font-size: 14px; color: #555; display: flex; align-items: center; gap: 10px; }
        .me-qr { margin-left: auto; display: flex; align-items: center; }
        .qr-img { width: 24px; height: 24px; object-fit: contain; opacity: 0.7; }
        .header-top-row { height: 44px; width: 100%; display: flex; justify-content: space-between; align-items: center; position: relative; }
        .header-search-row { width: 100%; display: none; margin-top: 2px; }
        .wechat-header-title { position: absolute; left: 50%; transform: translateX(-50%); font-size: 16px; font-weight: 600; pointer-events: none; }
        .wechat-header-left { flex: 1; } 
        .wechat-header-right { flex: 1; display: flex; justify-content: flex-end; align-items: center; gap: 10px; }
        .right-icon-img { width: 24px; height: 24px; object-fit: contain; display: none; cursor: pointer; }
        
        .wechat-body { 
            position: absolute;
            top: calc(var(--wx-body-base-top) + var(--status-bar-offset)); 
            bottom: 80px; 
            left: 0; right: 0;
            overflow-y: auto; 
            overflow-x: hidden; 
            background-color: transparent; 
            padding: 0;
        }

        .tab-page { width: 100%; min-height: 100%; display: none; flex-direction: column; }
        .tab-page.active { display: flex; }
        .wx-cell-group { margin-top: 10px; background-color: #fff; border-radius: 12px; margin-left: 12px; margin-right: 12px; overflow: hidden; }
        .wx-cell { display: flex; align-items: center; padding: 14px 16px; background-color: #fff; position: relative; }
        .wx-cell:active { background-color: #f0f0f0; }
        .wx-cell:not(:last-child)::after { content: ''; position: absolute; bottom: 0; left: 60px; right: 0; height: 1px; background-color: #e5e5e5; transform: scaleY(0.5); }
        .wx-cell-icon { width: 24px; height: 24px; margin-right: 16px; border-radius: 4px; display: flex; justify-content: center; align-items: center; overflow: hidden; background-color: var(--default-avatar-bg); }
        .wx-cell-icon img { width: 100%; height: 100%; object-fit: cover; border-radius: 4px; }
        .wx-cell-text { flex: 1; font-size: 16px; color: #111; }
        .wx-cell-arrow { font-size: 14px; color: #b2b2b2; display: flex; align-items: center; }
        .wx-search-box { background-color: rgba(255,255,255,0.6); border-radius: 10px; height: 36px; display: flex; align-items: center; justify-content: center; color: #7d7d7d; font-size: 15px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        
        .collapsible-header { padding: 14px 16px; background-color: #fff; display: flex; justify-content: space-between; align-items: center; cursor: pointer; font-size: 16px; color: #111; font-weight: 400; }
        .collapsible-header:active { background-color: #f5f5f5; }
        
        .wb-group-header {
            font-size: 18px;
            font-weight: 600;
            padding: 18px 16px;
        }

        .collapsible-content { display: none; border-top: 1px solid #f0f0f0; padding: 0; width: 100%; overflow: hidden; }
        .collapsible-content.show { display: block; }

        .rotate-icon { transition: transform 0.2s; }
        .rotate-icon.down { transform: rotate(90deg); }
        .wechat-footer { position: absolute; bottom: 20px; left: 12px; right: 12px; height: 60px; background: var(--glass-bg); backdrop-filter: var(--glass-blur); -webkit-backdrop-filter: var(--glass-blur); border-radius: var(--glass-radius); box-shadow: var(--glass-shadow); border: 1px solid rgba(255,255,255,0.3); display: flex; justify-content: space-around; align-items: center; z-index: 101; }
        .tab-item { display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 10px; gap: 3px; width: 25%; cursor: pointer; color: #333; opacity: 0.5; }
        .tab-item:active { transform: scale(0.95); }
        .tab-item.active { opacity: 1; color: #000; }
        .tab-icon-box { width: 28px; height: 28px; background-color: transparent; background-size: contain; background-repeat: no-repeat; background-position: center; }
        .icon-chat { background-image: url('https://i.postimg.cc/8kJHd3Qr/IMG-0845.png'); }
        .icon-contact { background-image: url('https://i.postimg.cc/wTDQZmBB/IMG-0846.png'); }
        .icon-discover { background-image: url('https://i.postimg.cc/521SV2HF/wu-biao-ti19-20260102063805.png'); }
        .icon-me { background-image: url('https://i.postimg.cc/521SV2Hj/wu-biao-ti19-20260102063838.png'); }

        /* --- 弹窗相关样式 --- */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 500;
            display: none;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .modal-overlay.show { display: block; opacity: 1; }

        .bottom-modal {
            position: fixed;
            bottom: -100%; left: 0; width: 100%;
            border-radius: 20px 20px 0 0;
            transition: bottom 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            z-index: 600;
            padding: 20px;
            box-shadow: 0 -5px 30px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            max-height: 85vh;
            overflow-y: auto;
            background-color: #fff; 
        }
        .bottom-modal.show { bottom: 0; }

        .center-modal {
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            background: #fff;
            border-radius: 12px;
            padding: 20px;
            width: 80%;
            max-width: 300px;
            z-index: 2000;
            display: none;
            flex-direction: column;
            align-items: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            opacity: 0;
            transition: all 0.2s;
        }
        .center-modal.show { display: flex; opacity: 1; transform: translate(-50%, -50%) scale(1); }

        .close-btn {
            position: absolute;
            top: 15px; right: 15px;
            width: 24px; height: 24px;
            cursor: pointer;
            z-index: 601;
        }

        .menu-btn {
            background-color: #000;
            color: #fff;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            text-align: center;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .menu-btn:active { opacity: 0.8; }
        
        .modal-form-content {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 25px;
            padding-bottom: 20px;
        }

        .avatar-edit-container {
            align-self: unset; 
            margin: 20px auto; 
            width: 80px; height: 80px;
            background-color: var(--default-avatar-bg);
            border-radius: 16px;
            overflow: hidden;
            position: relative;
            cursor: pointer;
            display: block;
        }
        .avatar-edit-container img { width: 100%; height: 100%; object-fit: cover; }

        .form-group { display: flex; flex-direction: column; gap: 5px; margin: 0 16px; }
        .form-label { font-size: 14px; font-weight: 600; color: #666; }
        .form-input {
            width: 100%;
            padding: 10px;
            background-color: #f2f2f2;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            outline: none;
        }
        .form-textarea {
            width: 100%;
            padding: 10px;
            background-color: #f2f2f2;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            min-height: 100px;
            outline: none;
            resize: none;
        }

        .save-btn {
            margin: 20px 16px;
            padding: 14px;
            background-color: #000; 
            color: #fff;          
            text-align: center;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }
        .save-btn:active { opacity: 0.8; }
        .black-btn {
            background-color: #000; color: #fff;
            padding: 14px; text-align: center; border-radius: 12px;
            font-size: 16px; font-weight: 600; cursor: pointer;
            margin-top: 10px;
        }

        .avatar-modal-bottom { z-index: 700; padding-top: 50px; }
        .avatar-preview {
            width: 120px; height: 120px;
            background-color: var(--default-avatar-bg);
            border-radius: 16px;
            align-self: center;
            margin: 20px 0;
            overflow: hidden;
        }
        .avatar-preview img { width: 100%; height: 100%; object-fit: cover; }
        
        .upload-local-btn {
            background-color: #000;
            color: #fff;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            font-weight: 500;
            cursor: pointer;
            margin-top: 10px;
        }

        .member-select-list {
            background-color: #f2f2f2;
            border-radius: 8px;
            max-height: 150px;
            overflow-y: auto;
            padding: 10px;
        }
        .member-item {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        .member-item:last-child { border-bottom: none; }
        .member-checkbox { margin-right: 10px; width: 18px; height: 18px; }

        .bound-books-display {
            width: 100%;
            min-height: 44px;
            background-color: #f2f2f2;
            border-radius: 8px;
            padding: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .bound-book-tag {
            background-color: #e0e0e0;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 12px;
            color: #333;
            display: flex;
            align-items: center;
        }

        /* --- 左滑删除样式 --- */
        .swipe-item-wrapper {
            position: relative;
            overflow: hidden;
            display: flex;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            width: 100%;
            scrollbar-width: none; 
        }
        .swipe-item-wrapper::-webkit-scrollbar { display: none; }
        
        .swipe-content-box {
            min-width: 100%; 
            scroll-snap-align: start;
            background: #fff;
            position: relative;
            z-index: 2;
            display: flex;
            align-items: center;
            padding: 14px 16px;
            box-sizing: border-box; 
        }
        .swipe-content-box:active { background-color: #f0f0f0; }
        
        .swipe-delete-btn {
            min-width: 80px;
            background-color: #ff3b30;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            scroll-snap-align: end;
            font-weight: 600;
            font-size: 15px;
        }
        
        .swipe-top-btn {
            min-width: 80px;
            background-color: #c7c7cc;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            scroll-snap-align: end;
            font-weight: 600;
            font-size: 15px;
        }
        
        .swipe-content-box::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 1px;
            background-color: #e5e5e5;
            transform: scaleY(0.5);
            z-index: 1;
        }

        /* --- 开关颜色修改 --- */
        input:checked + .slider { background-color: #000; }

        /* --- 聊天界面样式 --- */
        #chat-interface {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--wx-bg-color);
            z-index: 300; 
            display: none;
            flex-direction: column;
        }
        #chat-interface.active { display: flex; }

        .chat-header {
            position: absolute;
            top: calc(var(--safe-area-top) + var(--status-bar-offset) + 6px);
            left: 12px; right: 12px;
            height: 44px;
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border-radius: var(--glass-radius);
            box-shadow: var(--glass-shadow);
            border: 1px solid rgba(255,255,255,0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 12px;
            z-index: 301;
        }

        .chat-header-title {
            font-size: 16px;
            font-weight: 600;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            color: #000;
            white-space: nowrap;
            pointer-events: none; 
        }

        .chat-header-icon {
            width: 24px;
            height: 24px;
            object-fit: contain;
            cursor: pointer;
            position: relative;
            z-index: 10; 
            pointer-events: auto;
        }

        .chat-content-area {
            position: absolute;
            top: calc(110px + var(--status-bar-offset));  
            bottom: 76px; 
            left: 0; right: 0;
            padding: 10px 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        
        .chat-row {
            display: flex;
            width: 100%;
            margin-bottom: 20px; 
            position: relative; 
            align-items: flex-start; 
        }
        .chat-row.role { justify-content: flex-start; }
        .chat-row.user { justify-content: flex-end; }
        
        .avatar-wrapper {
            position: absolute;
            top: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 40px;
        }
        .chat-row.role .avatar-wrapper { left: 0; }
        .chat-row.user .avatar-wrapper { right: 0; }

        .chat-avatar { width: 40px; height: 40px; border-radius: 6px; object-fit: cover; background-color: var(--default-avatar-bg); }
        
        .chat-time-label {
            font-size: 10px;
            color: #999;
            margin-top: 2px;
            white-space: nowrap;
        }

        .chat-bubble {
            max-width: calc(100% - 60px); 
            padding: 6px 10px; 
            font-size: 14px; 
            line-height: 1.4;
            word-wrap: break-word;
            position: relative;
            width: fit-content; 
            margin-top: 10px; 
        }
        
        .chat-row.role .chat-bubble {
            background-color: var(--chat-bubble-role);
            color: #fff;
            border-radius: 0 12px 12px 12px;
            margin-left: 50px; 
        }
        
        .chat-row.user .chat-bubble {
            background-color: var(--chat-bubble-user);
            color: #000;
            border-radius: 12px 0 12px 12px;
            border: 1px solid rgba(0,0,0,0.05); 
            margin-right: 50px; 
        }

        .chat-footer {
            position: absolute;
            bottom: 20px;
            left: 12px; right: 12px;
            min-height: 56px;
            height: auto;
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border-radius: var(--glass-radius);
            box-shadow: var(--glass-shadow);
            border: 1px solid rgba(255,255,255,0.3);
            display: flex;
            align-items: center;
            padding: 8px 10px;
            z-index: 301;
            gap: 10px;
            transition: height 0.1s;
        }

        .chat-footer-icon { width: 28px; height: 28px; object-fit: contain; cursor: pointer; flex-shrink: 0; display: block; }
        .chat-footer-right-actions { display: flex; align-items: center; justify-content: flex-end; min-width: 66px; flex-shrink: 0; gap: 10px; }
        .hidden { display: none !important; }
        .chat-input-wrapper { 
            flex: 1; 
            position: relative; 
            /* 修改：高度改为 auto，最小高度匹配输入框 */
            height: auto; 
            min-height: 36px;
            display: flex; 
            align-items: center; 
        }
        .chat-input-field { 
            width: 100%; 
            /* 修改：高度由 JS 控制，设置最大高度 */
            height: 36px; 
            max-height: 120px; /* 限制最大高度，超过滚动 */
            border-radius: 8px; 
            /* 修改：添加淡灰色边框 (需求2) */
            border: 1px solid #dcdcdc; 
            background-color: #fff; 
            padding: 8px 40px 8px 10px; /* 调整内边距适应文字 */
            font-size: 15px; 
            outline: none;
            resize: none; /* 禁止手动拖拽 */
            overflow-y: auto; /* 内容多时显示滚动条 */
            line-height: 1.4;
            font-family: inherit;
        }
        .chat-input-reply-icon { position: absolute; right: 5px; top: 50%; transform: translateY(-50%); width: 24px; height: 24px; cursor: pointer; }
        #btn-send { height: 32px; width: auto; object-fit: contain; }

        /* --- 设置界面 --- */
        #settings-interface {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: #f2f2f6; 
            z-index: 400; 
            display: none;
            flex-direction: column;
        }
        #settings-interface.active { display: flex; }
        
        .settings-content { 
            position: absolute;
            top: calc(110px + var(--status-bar-offset));  
            bottom: 20px; 
            left: 0; right: 0;
            padding: 10px 16px; 
            overflow-y: auto; 
        }
        
        .settings-section { background-color: #fff; border-radius: 12px; margin-bottom: 20px; overflow: hidden; }
        .settings-header-item { padding: 15px; font-size: 16px; font-weight: 500; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .settings-body { display: none; padding: 0 15px 20px 15px; border-top: 1px solid #f0f0f0; }
        .settings-body.show { display: block; }
        .api-input-group { margin-top: 15px; }
        .api-btn-row { display: flex; gap: 10px; margin-top: 20px; }
        .api-btn { flex: 1; padding: 12px; border-radius: 8px; font-size: 14px; font-weight: 600; text-align: center; cursor: pointer; }
        .btn-pull { background-color: #e5e5e5; color: #000; }
        .btn-save { background-color: #000; color: #fff; }
        .model-select-wrapper { position: relative; }
        .model-arrow-icon { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #999; pointer-events: none; z-index: 1; font-size: 14px; }
        .hidden-select-overlay { position: absolute; top: 0; right: 0; width: 40px; height: 100%; opacity: 0; z-index: 2; cursor: pointer; }

        /* --- Miyo 内部独立设置界面 --- */
        #miyo-settings-interface {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--wx-bg-color); 
            z-index: 450; 
            display: none;
            flex-direction: column;
        }
        #miyo-settings-interface.active { display: flex; }

        /* --- 用户预设界面 --- */
        #user-presets-interface {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--wx-bg-color);
            z-index: 500;
            display: none;
            flex-direction: column;
        }
        #user-presets-interface.active { display: flex; }

        /* --- 聊天-更多界面 --- */
        #chat-more-interface {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--wx-bg-color); z-index: 350; display: none; flex-direction: column;
        }
        #chat-more-interface.active { display: flex; }
        
        .more-scroll-body {
            position: absolute;
            top: calc(110px + var(--status-bar-offset));
            bottom: 20px;
            left: 0; right: 0;
            padding: 10px 12px;
            overflow-y: auto; 
        }
        
        .more-scroll-body .wx-cell-group {
            margin-left: 0 !important;
            margin-right: 0 !important;
            width: 100%; 
        }

        .role-header-card {
            background: var(--glass-bg); backdrop-filter: var(--glass-blur); -webkit-backdrop-filter: var(--glass-blur);
            border-radius: var(--glass-radius); box-shadow: var(--glass-shadow); border: 1px solid rgba(255,255,255,0.3);
            display: flex; padding: 30px 24px; align-items: center; 
            margin: 0 0 15px 0; position: relative; z-index: 102;
        }

        .ios-toggle { position: relative; display: inline-block; width: 50px; height: 30px; }
        .ios-toggle input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 30px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        input:checked + .slider:before { transform: translateX(20px); }

        .delete-confirm-content {
            display: flex; flex-direction: column; justify-content: center; gap: 20px; margin-top: 30px;
        }
        .delete-text { font-size: 16px; font-weight: 500; text-align: center; color: #333; }

        .recent-chat-list {
            padding: 0 12px 10px 12px;
            display: flex; flex-direction: column; gap: 10px;
        }

        .recent-chat-wrapper {
            position: relative;
            overflow: hidden;
            display: flex;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            width: 100%;
            scrollbar-width: none;
            border-radius: var(--glass-radius);
            box-shadow: var(--glass-shadow);
        }
        .recent-chat-wrapper::-webkit-scrollbar { display: none; }

        .recent-chat-content {
            min-width: 100%;
            scroll-snap-align: start;
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border: 1px solid rgba(255,255,255,0.3);
            display: flex;
            align-items: center;
            padding: 16px;
            position: relative;
            cursor: pointer;
            transition: transform 0.1s;
        }
        .recent-chat-content:active { background-color: rgba(255,255,255,0.8); }
        
        .recent-chat-avatar { width: 50px; height: 50px; border-radius: 8px; margin-right: 15px; object-fit: cover; background-color: var(--default-avatar-bg); }
        .recent-chat-info { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .recent-chat-name { font-size: 16px; font-weight: 600; color: #000; margin-bottom: 4px; }
        .recent-chat-msg { font-size: 14px; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .recent-chat-time { font-size: 12px; color: #999; position: absolute; top: 18px; right: 16px; }

        /* --- 世界书界面样式 --- */
        #worldbook-interface {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--wx-bg-color); z-index: 450; display: none; flex-direction: column;
        }
        #worldbook-interface.active { display: flex; }
        
        .wb-content { 
            position: absolute;
            top: calc(98px + var(--status-bar-offset));
            bottom: 20px;
            left: 0; right: 0;
            padding: 10px 12px; 
            overflow-y: auto; 
        }
        
        .relative-wrapper {
            position: relative;
            width: 100%;
        }

        .custom-select-container {
            width: 100%; padding: 10px; background-color: #f2f2f2; border-radius: 8px; font-size: 16px;
            color: #999; cursor: pointer;
            display: flex; justify-content: space-between; align-items: center;
        }
        .custom-select-container.selected { color: #000; }
        
        .dropdown-list {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            z-index: 100;
            margin-top: 5px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .wb-list-item {
            padding: 12px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;
        }

        /* --- 新增：桌面美化设置样式 --- */
        .setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .setting-row:last-child { border-bottom: none; }
        
        .setting-label { font-size: 15px; color: #333; }
        
        .setting-btn-group { display: flex; gap: 8px; }
        
        .mini-btn {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            background-color: #f2f2f2;
            color: #333;
            cursor: pointer;
            font-weight: 500;
        }
        .mini-btn:active { background-color: #e5e5e5; }
        
        .wallpaper-preview-box {
            width: 100%;
            height: 160px;
            background-color: #f9f9f9;
            margin-top: 10px;
            margin-bottom: 10px;
            border-radius: 12px;
            object-fit: cover;
            border: 1px solid #eee;
            display: none; /* 默认隐藏，有图时显示 */
        }
        .wallpaper-preview-box.show { display: block; }

        .slider-container {
            padding: 10px 5px 20px 5px;
            width: 100%;
        }
        
        /* 强制背景为纯白，覆盖默认图片 */
        .wallpaper-layer {
            background-color: #ffffff !important;
        }
        
        /* 滑动条样式 */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #000;
            cursor: pointer;
            margin-top: -8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #e5e5e5;
            border-radius: 2px;
        }

                        /* --- 修正：用户预设列表卡片样式 --- */
        .preset-card-wrapper {
            margin: 12px 16px !important; /* 强制悬浮外边距 */
            width: auto !important; /* 覆盖默认的100%宽度 */
            border-radius: 18px !important; /* 大圆角 */
            box-shadow: 0 4px 15px rgba(0,0,0,0.06); /* 阴影 */
            
            /* --- 核心修复开始 --- */
            /* 原本是 overflow: hidden，这禁止了滚动。 */
            /* 改为允许 X 轴滚动（实现左滑），隐藏 Y 轴溢出 */
            overflow-x: auto !important; 
            overflow-y: hidden !important;
            /* 确保滚动捕捉生效 */
            scroll-snap-type: x mandatory;
            /* --- 核心修复结束 --- */
            
            background-color: #fff; /* 卡片背景 */
            border: 1px solid rgba(0,0,0,0.02);
            
            /* 隐藏滚动条 */
            scrollbar-width: none; 
        }
        
        /* 确保 Webkit 浏览器（如 Safari/Chrome）隐藏滚动条 */
        .preset-card-wrapper::-webkit-scrollbar { 
            display: none; 
        }
        
        /* 调整内容区域高度 */
        .preset-card-content {
            height: 84px !important;
            padding: 0 16px !important;
        }
        
        /* 大头像样式 */
        .preset-avatar-large {
            width: 54px !important; 
            height: 54px !important;
            border-radius: 12px !important;
            margin-right: 16px !important;
            object-fit: cover;
            flex-shrink: 0;
            background-color: var(--default-avatar-bg);
        }
        
        /* 名字样式 */
        .preset-name-text {
            font-size: 17px !important;
            font-weight: 600 !important;
            color: #000;
        }

        /* --- 新增：选择用户预设弹窗样式 --- */
        .preset-select-item {
            background-color: #f7f7f7;
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 12px;
            border: 1px solid transparent;
            transition: all 0.2s;
        }
        .preset-select-item.active {
            border-color: #000;
            background-color: #fff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .preset-select-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer; /* 点击头部展开预览 */
        }
        
        .preset-select-info {
            display: flex;
            align-items: center;
            flex: 1;
        }
        
        .preset-select-checkbox {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            border: 2px solid #ccc;
            margin-left: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            flex-shrink: 0;
        }
        .preset-select-checkbox.checked {
            background-color: #000;
            border-color: #000;
        }
        .preset-select-checkbox.checked::after {
            content: '';
            width: 10px;
            height: 5px;
            border-left: 2px solid #fff;
            border-bottom: 2px solid #fff;
            transform: rotate(-45deg) translate(1px, -1px);
        }

        .preset-preview-details {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #eee;
            font-size: 13px;
            color: #666;
            display: none; /* 默认折叠 */
            line-height: 1.5;
        }
        .preset-preview-details.show { display: block; }
        /* --- 新增：左滑菜单按钮样式 --- */
        .swipe-display-btn {
            min-width: 80px;
            background-color: #007aff; /* iOS 蓝色 */
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            scroll-snap-align: end;
            font-weight: 600;
            font-size: 15px;
            text-align: center;
            padding: 0 10px;
        }
                /* --- 修改：置顶虚线边框样式 (加在 wrapper 上) --- */
        .pinned-border {
            /* 虚线边框 */
            border: 1px dashed #999 !important; 
            /* 确保圆角 */
            border-radius: var(--glass-radius); 
            /* 加上背景色，这样整个条目(包括滑出来的按钮背景)都会有这个底色 */
            background-color: rgba(235, 235, 235, 0.95) !important;
            /* 确保边框在最上层 */
            box-sizing: border-box;
        }
        /* 当 wrapper 有 pinned-border 时，内部 content 去掉默认边框 */
        .pinned-border .recent-chat-content {
            border: none !important;
            background-color: transparent !important; /* 让外层背景透出来 */
        }
        /* --- 修改：置顶样式 --- */
        .pinned-border {
            /* 黑色虚线边框 */
            border: 1px dashed #000 !important; 
            /* 背景色保持原样 (玻璃拟态)，覆盖之前的灰色背景设置 */
            background-color: var(--glass-bg) !important;
            backdrop-filter: var(--glass-blur) !important;
            -webkit-backdrop-filter: var(--glass-blur) !important;
            box-sizing: border-box;
        }
        
        /* 置顶图标样式 */
        .pin-icon-img {
            position: absolute;
            bottom: 8px;
            right: 8px;
            width: 14px;
            height: 14px;
            object-fit: contain;
            z-index: 5;
            pointer-events: none; /* 防止遮挡点击 */
        }

        /* --- 表情包功能样式 --- */
        .sticker-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            padding: 10px;
        }
        
        .sticker-item {
            position: relative;
            aspect-ratio: 1/1;
            border-radius: 8px;
            overflow: hidden;
            background-color: #f2f2f2;
            cursor: pointer;
        }
        
        .sticker-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .sticker-desc {
            position: absolute;
            bottom: 0; left: 0; right: 0;
            background: rgba(0,0,0,0.5);
            color: white;
            font-size: 10px;
            padding: 2px;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* 删除模式下的遮罩 */
        .sticker-delete-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.3);
            display: none;
            align-items: center;
            justify-content: center;
        }
        .sticker-item.selected .sticker-delete-overlay {
            display: flex;
            background: rgba(0,0,0,0.6);
        }
        .sticker-check-icon {
            width: 20px; height: 20px;
            border-radius: 50%;
            border: 2px solid #fff;
        }
        .sticker-item.selected .sticker-check-icon {
            background-color: #ff3b30;
            border-color: #ff3b30;
        }

        .sticker-modal-header-left {
            display: flex;
            gap: 15px;
            align-items: center;
            font-size: 14px;
            font-weight: 600;
        }
        
        .sticker-modal-footer {
            display: flex;
            justify-content: space-between;
            padding: 15px 20px;
            border-top: 1px solid #eee;
            background: #fff;
        }
        
        .text-btn { font-size: 16px; font-weight: 600; cursor: pointer; }
        .text-btn.cancel { color: #000; }
        .text-btn.delete { color: #ff3b30; }

        .preview-box-large {
            width: 120px; height: 120px;
            background-color: #eee;
            border-radius: 8px;
            margin: 10px auto;
            display: block;
            object-fit: cover;
        }
        .sticker-header-btn {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            display: inline-block;
        }
        .sticker-btn-black {
            background-color: #000;
            color: #fff;
        }
        .sticker-btn-red {
            background-color: #ff3b30;
            color: #fff;
        }
    </style>
</head>
<body>

    <div class="wallpaper-container">
        <div id="bg-layer-1" class="wallpaper-layer"></div>
        <div id="bg-layer-2" class="wallpaper-layer"></div>
    </div>

    <div class="ui-container">
        <div class="dynamic-island"></div>

        <div class="status-bar light-content" id="statusBar">
            <div class="status-time" id="status-clock">12:00</div>
            <div class="status-icons">
                <img src="https://i.postimg.cc/Vsxq5n17/IMG-0825.png" class="status-img icon-signal">
                <img src="https://i.postimg.cc/v8JrDfMq/IMG-0824.png" class="status-img icon-wifi">
                <img src="https://i.postimg.cc/kM0QDK9N/IMG-0823.png" class="status-img icon-battery">
            </div>
        </div>

        <!-- Miyo App -->
        <div id="wechat-app" class="app-window">
            <div class="wechat-header" id="wx-header">
                <div class="header-top-row">
                    <div class="wechat-header-left"></div>
                    <div class="wechat-header-title" id="wx-title">Miyo</div>
                    <div class="wechat-header-right">
                        <img id="wx-right-icon" src="" class="right-icon-img">
                    </div>
                </div>
                <div class="header-search-row" id="wx-header-search">
                    <div class="wx-search-box"><i class="fas fa-search" style="margin-right:5px;"></i> 搜索</div>
                </div>
            </div>

            <div class="me-top-card-container" id="me-header-card">
                <!-- 修改：手动更新默认头像 -->
                <img src="https://i.postimg.cc/TPSZtKjJ/IMG-1077.png" class="me-avatar">
                <div class="me-info">
                    <div class="me-nickname">User</div>
                    <div class="me-wxid">Miyo号: Miyo0102</div>
                </div>
                <div class="me-qr">
                    <img src="https://i.postimg.cc/9f9TS4VP/wu-biao-ti19-20260102074730.png" class="qr-img">
                </div>
            </div>
            
            <div class="wechat-body" id="wx-body">
                <div class="tab-page active" id="page-chat">
                    <div class="recent-chat-list" id="recentChatList"></div>
                </div>
                
                <div class="tab-page" id="page-contact">
                    <div class="wx-cell-group" style="margin-top: 0;">
                        <div class="collapsible-header" onclick="toggleGroup('friends')">
                            <span>好友</span><i class="fas fa-chevron-right rotate-icon" id="icon-friends"></i>
                        </div>
                        <div class="collapsible-content" id="content-friends"></div>
                    </div>
                    <div class="wx-cell-group">
                        <div class="collapsible-header" onclick="toggleGroup('groups')">
                            <span>群聊</span><i class="fas fa-chevron-right rotate-icon" id="icon-groups"></i>
                        </div>
                        <div class="collapsible-content" id="content-groups"></div>
                    </div>
                </div>

                <div class="tab-page" id="page-discover">
                    <div class="wx-cell-group" style="margin-top: 0;">
                        <div class="wx-cell"><div class="wx-cell-icon"><img src="https://i.postimg.cc/ncTyWk1L/wu-biao-ti19-20260102084012.png"></div><div class="wx-cell-text">朋友圈</div><div class="wx-cell-arrow"><i class="fas fa-chevron-right"></i></div></div>
                    </div>
                    <div class="wx-cell-group">
                        <div class="wx-cell">
                            <div class="wx-cell-icon"><img src="https://i.postimg.cc/P5ZVsx2D/wu-biao-ti19-20260102164727.png"></div>
                            <div class="wx-cell-text">情侣空间</div>
                            <div class="wx-cell-arrow"><i class="fas fa-chevron-right"></i></div>
                        </div>
                    </div>
                    <div class="wx-cell-group">
                        <div class="wx-cell"><div class="wx-cell-icon"><img src="https://i.postimg.cc/9f9TS4VP/wu-biao-ti19-20260102074730.png"></div><div class="wx-cell-text">扫码加好友</div><div class="wx-cell-arrow"><i class="fas fa-chevron-right"></i></div></div>
                    </div>
                    <div class="wx-cell-group">
                        <div class="wx-cell"><div class="wx-cell-icon"><img src="https://i.postimg.cc/ZKYg6NzM/wu-biao-ti19-20260102084032.png"></div><div class="wx-cell-text">小游戏</div><div class="wx-cell-arrow"><i class="fas fa-chevron-right"></i></div></div>
                    </div>
                </div>

                <div class="tab-page" id="page-me">
                    <div class="wx-cell-group" style="margin-top: 0;">
                         <div class="wx-cell">
                            <div class="wx-cell-icon"><img src="https://i.postimg.cc/KYD9jWX4/wu-biao-ti19-20260102164743.png"></div>
                            <div class="wx-cell-text">钱包</div>
                            <div class="wx-cell-arrow"><i class="fas fa-chevron-right"></i></div>
                        </div>
                    </div>
                    <div class="wx-cell-group">
                         <div class="wx-cell" onclick="openWorldBookInterface()">
                            <div class="wx-cell-icon"><img src="https://i.postimg.cc/VNW7vhyv/wu-biao-ti19-20260102164800.png"></div>
                            <div class="wx-cell-text">世界书</div>
                            <div class="wx-cell-arrow"><i class="fas fa-chevron-right"></i></div>
                        </div>
                    </div>
                    <div class="wx-cell-group">
                        <div class="wx-cell" onclick="openMiyoSettings()">
                            <div class="wx-cell-icon"><img src="https://i.postimg.cc/kg9vmgV8/wu-biao-ti19-20260102063712.png"></div>
                            <div class="wx-cell-text">设置</div>
                            <div class="wx-cell-arrow"><i class="fas fa-chevron-right"></i></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 聊天界面 -->
            <div id="chat-interface">
                <div class="chat-header">
                    <img src="https://i.postimg.cc/5yYPbtpG/wu-biao-ti19-20260103195316.png" class="chat-header-icon" onclick="closeChatWindow()">
                    <div class="chat-header-title" id="chatTitle">Role Name</div>
                    <img src="https://i.postimg.cc/vTJ0BdSk/wu-biao-ti19-20260103195427.png" class="chat-header-icon" onclick="openChatMore()">
                </div>
                <div class="chat-content-area" id="chatContent">
                    <!-- 聊天记录 -->
                </div>
                <div class="chat-footer">
                    <img src="https://i.postimg.cc/VvxK6cHT/wu-biao-ti19-20260103195407.png" class="chat-footer-icon">
                                        <div class="chat-input-wrapper">
                        <!-- 修改：将 input 换为 textarea，并添加 autoResizeInput -->
                        <textarea class="chat-input-field" id="chatInput" rows="1" oninput="checkInput(); autoResizeInput(this)"></textarea>
                        
                        <img id="icon-reply" src="https://i.postimg.cc/cJz9jYBy/wu-biao-ti19-20260103195736.png" class="chat-input-reply-icon" onclick="receiveReply()">
                    </div>
                    
                    <div class="chat-footer-right-actions">
                        <div id="icons-group" style="display:flex; gap:10px; align-items:center;">
                            <!-- 修改前可能没有 onclick -->
<img src="https://i.postimg.cc/br7mJjBX/wu-biao-ti19-20260103195333.png" class="chat-footer-icon" onclick="openStickerModal()">
                            <img src="https://i.postimg.cc/J0fpnWdf/wu-biao-ti19-20260103195450.png" class="chat-footer-icon">
                        </div>
                        <img id="btn-send" src="https://i.postimg.cc/nrxh4X57/IMG-0906.png" class="hidden" onclick="sendUserMessage()">
                    </div>
                </div>
            </div>

            <!-- 聊天 - 更多界面 -->
            <div id="chat-more-interface">
                <div class="chat-header">
                    <img src="https://i.postimg.cc/5yYPbtpG/wu-biao-ti19-20260103195316.png" class="chat-header-icon" onclick="closeChatMore()">
                    <div class="chat-header-title">更多</div>
                    <div style="width:24px;"></div>
                </div>
                
                <div class="more-scroll-body">
                    <div class="role-header-card" id="more-role-card">
                        <img src="" class="me-avatar" id="more-role-avatar-img">
                        <div class="me-info">
                            <div class="me-nickname" id="more-role-name-display">Role</div>
                            <div class="me-wxid" id="more-role-id-display">Miyo号: </div>
                        </div>
                        <div class="me-qr">
                            <img src="https://i.postimg.cc/9f9TS4VP/wu-biao-ti19-20260102074730.png" class="qr-img">
                        </div>
                    </div>

                    <div class="wx-cell-group">
                        <div class="collapsible-header" onclick="toggleGroup('role-settings')">
                            <span>修改角色设定</span><i class="fas fa-chevron-right rotate-icon" id="icon-role-settings"></i>
                        </div>
                        <div class="collapsible-content" id="content-role-settings">
                             <div class="avatar-edit-container" onclick="openAvatarSettings('role_edit')">
                                <img id="editRoleAvatarPreview" src="">
                            </div>
                            <div class="form-group"><span class="form-label">角色真名</span><input type="text" class="form-input" id="editRoleRealName"></div>
                            <div class="form-group"><span class="form-label">角色Miyo名</span><input type="text" class="form-input" id="editRoleMiyoName"></div>
                            <div class="form-group"><span class="form-label">给角色的备注</span><input type="text" class="form-input" id="editRoleRemark"></div>
                            <div class="form-group"><span class="form-label">角色Miyo号</span><input type="text" class="form-input" id="editRoleMiyoID"></div>
                            <div class="form-group"><span class="form-label">角色签名</span><input type="text" class="form-input" id="editRoleSign"></div>
                            <div class="form-group"><span class="form-label">角色人设</span><textarea class="form-textarea" id="editRolePersona"></textarea></div>
                            <div class="save-btn" onclick="saveMoreRoleSettings()">保存</div>
                        </div>
                    </div>

                    <div class="wx-cell-group">
                        <div class="collapsible-header" onclick="toggleGroup('user-settings')">
                            <span>修改用户设定</span><i class="fas fa-chevron-right rotate-icon" id="icon-user-settings"></i>
                        </div>
                        <div class="collapsible-content" id="content-user-settings">
                             <div class="avatar-edit-container" onclick="openAvatarSettings('user_edit')">
                                <!-- 修改：手动更新默认头像 -->
                                 <img id="editUserAvatarPreview" src="https://i.postimg.cc/TPSZtKjJ/IMG-1077.png">
                            </div>
                            <div class="form-group"><span class="form-label">用户真名</span><input type="text" class="form-input" id="editUserRealName"></div>
                            <div class="form-group"><span class="form-label">用户Miyo名</span><input type="text" class="form-input" id="editUserMiyoName"></div>
                            <div class="form-group"><span class="form-label">用户Miyo号</span><input type="text" class="form-input" id="editUserMiyoID"></div>
                            <div class="form-group"><span class="form-label">用户签名</span><input type="text" class="form-input" id="editUserSign"></div>
                            <div class="form-group"><span class="form-label">用户人设</span><textarea class="form-textarea" id="editUserPersona"></textarea></div>
    <!-- 在 save-btn 上方插入 -->
    <div class="upload-local-btn" style="background-color: #333; margin: 10px 16px;" onclick="openSelectUserPresetModal()">选择已添加的用户预设</div>
                            <div class="save-btn" onclick="saveMoreUserSettings()">保存</div>
                        </div>
                    </div>

                    <div class="wx-cell-group">
                        <div class="wx-cell" onclick="openBindWorldBookModal()">
                            <div class="wx-cell-text">绑定世界书</div>
                            <div class="wx-cell-arrow"><i class="fas fa-chevron-right"></i></div>
                        </div>
                    </div>

                    <!-- 【新增】上下文记忆条数设置 -->
                    <div class="wx-cell-group">
                        <div class="wx-cell">
                             <div class="wx-cell-text">角色上下文记忆 (条)</div>
                             <!-- 限制输入 1-5000，失去焦点或回车时自动保存 -->
                             <input type="number" id="inputContextLimit" class="form-input" 
                                    style="width: 80px; text-align: right; background: transparent; border: 1px solid #ddd; padding: 4px 8px; height: 30px;" 
                                    placeholder="100" min="1" max="5000"
                                    onchange="saveContextLimit()">
                        </div>
                    </div>

                    <div class="wx-cell-group">
                         <div class="wx-cell" onclick="showDeleteConfirm()">
                            <div class="wx-cell-text" style="color: #000;">删除所有聊天记录</div>
                            <div class="wx-cell-arrow"><i class="fas fa-chevron-right"></i></div>
                        </div>
                    </div>

                    <div class="wx-cell-group">
                        <div class="wx-cell">
                            <div class="wx-cell-text">以现实时间为准</div>
                            <div style="margin-left: auto;">
                                <label class="ios-toggle">
                                    <input type="checkbox" id="realTimeToggle" onchange="toggleRealTime()">
                                    <span class="slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="wx-cell-group">
                         <div class="wx-cell">
                            <div class="wx-cell-text">导出聊天数据</div>
                            <div class="wx-cell-arrow"><i class="fas fa-chevron-right"></i></div>
                        </div>
                    </div>

                </div>
            </div>

            <!-- 世界书界面 -->
            <div id="worldbook-interface">
                <div class="chat-header">
                    <img src="https://i.postimg.cc/5yYPbtpG/wu-biao-ti19-20260103195316.png" class="chat-header-icon" onclick="closeWorldBookInterface()">
                    <div class="chat-header-title">世界书</div>
                    <div style="display:flex; gap:10px;">
                        <img src="https://i.postimg.cc/Y0FQLJJ8/wu-biao-ti19-20260104145957.png" class="chat-header-icon" onclick="openGroupSettingsModal()">
                        <img src="https://i.postimg.cc/sgy4rgBh/wu-biao-ti19-20260102063856.png" class="chat-header-icon" onclick="openAddWorldBookModal()">
                    </div>
                </div>
                <div class="wb-content" id="worldBookContent">
                    <!-- 世界书列表展示区域 -->
                </div>
            </div>

            <div class="wechat-footer">
                <div class="tab-item active" onclick="switchTab(0)"><div class="tab-icon-box icon-chat"></div><span>Miyo</span></div>
                <div class="tab-item" onclick="switchTab(1)"><div class="tab-icon-box icon-contact"></div><span>联系人</span></div>
                <div class="tab-item" onclick="switchTab(2)"><div class="tab-icon-box icon-discover"></div><span>探索</span></div>
                <div class="tab-item" onclick="switchTab(3)"><div class="tab-icon-box icon-me"></div><span>我</span></div>
            </div>


        </div>
        
        <!-- 全局设置界面 -->
        <div id="settings-interface">
            <div class="chat-header">
                <div style="width: 24px;"></div>
                <div class="chat-header-title">设置</div>
                <div style="width:24px;"></div> 
            </div>
            <div class="settings-content">
                <div class="settings-section">
                    <div class="settings-header-item" onclick="toggleApiSettings()">
                        <span>API设置</span>
                        <i class="fas fa-chevron-right rotate-icon" id="icon-api-arrow"></i>
                    </div>
                    <div class="settings-body" id="api-settings-body">
                        <div class="api-input-group">
                            <div class="form-label">API反代地址</div>
                            <input type="text" class="form-input" id="inputApiUrl" placeholder="例如: https://api.openai.com">
                        </div>
                        <div class="api-input-group">
                            <div class="form-label">密钥</div>
                            <input type="password" class="form-input" id="inputApiKey" placeholder="sk-...">
                        </div>
                        <div class="api-input-group">
                            <div class="form-label">模型名称</div>
                            <div class="model-select-wrapper">
                                <input type="text" class="form-input" id="inputModelName" placeholder="例如: gpt-3.5-turbo">
                                <i class="fas fa-chevron-down model-arrow-icon"></i>
                                <select id="selectModelList" class="hidden-select-overlay" onchange="document.getElementById('inputModelName').value=this.value">
                                    <option value="" disabled selected>选择模型...</option>
                                </select>
                            </div>
                        </div>
                        <div class="api-btn-row">
                            <div class="api-btn btn-pull" onclick="pullModels()">拉取模型</div>
                            <div class="api-btn btn-save" onclick="saveApiSettings()">保存</div>
                        </div>
                    </div>
                </div>
                <!-- 新增：桌面美化设置板块 -->
                <div class="settings-section">
                    <div class="settings-header-item" onclick="toggleDesktopSettings()">
                        <span>桌面美化</span>
                        <i class="fas fa-chevron-right rotate-icon" id="icon-desktop-arrow"></i>
                    </div>
                                        <div class="settings-body" id="desktop-settings-body">
                        
                        <!-- 桌面1 壁纸设置 -->
                        <div class="setting-row">
                            <span class="setting-label">桌面1 壁纸</span>
                            <div class="setting-btn-group">
                                <!-- 新增：恢复默认按钮 -->
                                <div class="mini-btn" onclick="resetWallpaper(1)">恢复默认</div>
                                <div class="mini-btn" onclick="document.getElementById('file-upload-wp-1').click()">本地上传</div>
                                <div class="mini-btn" onclick="triggerUrlUpload(1)">URL链接</div>
                            </div>
                        </div>
                        <img id="preview-wp-1" class="wallpaper-preview-box">

                        <!-- 桌面2 壁纸设置 -->
                        <div class="setting-row">
                            <span class="setting-label">桌面2 壁纸</span>
                            <div class="setting-btn-group">
                                <!-- 新增：恢复默认按钮 -->
                                <div class="mini-btn" onclick="resetWallpaper(2)">恢复默认</div>
                                <div class="mini-btn" onclick="document.getElementById('file-upload-wp-2').click()">本地上传</div>
                                <div class="mini-btn" onclick="triggerUrlUpload(2)">URL链接</div>
                            </div>
                        </div>
                        <img id="preview-wp-2" class="wallpaper-preview-box">

                                                <!-- 状态栏设置 -->
                        <div class="setting-row">
                            <span class="setting-label">显示状态栏</span>
                            <label class="ios-toggle">
                                <input type="checkbox" id="statusBarToggle" onchange="toggleStatusBarVisibility()" checked>
                                <span class="slider"></span>
                            </label>
                        </div>

                        <div class="setting-row" style="border-bottom:none; padding-bottom:0;">
                            <span class="setting-label">调整状态栏位置</span>
                        </div>
                        <div class="slider-container">
                            <input type="range" min="-20" max="60" value="0" id="statusBarSlider" oninput="updateStatusBarPosition(this.value)">
                        </div>

                    </div>
                </div>

                <!-- 隐藏的文件上传控件 -->
                <input type="file" id="file-upload-wp-1" accept="image/*" hidden onchange="handleWallpaperFile(this, 1)">
                <input type="file" id="file-upload-wp-2" accept="image/*" hidden onchange="handleWallpaperFile(this, 2)">
            </div>
        </div>


        <!-- Miyo 内部独立设置界面 -->
        <div id="miyo-settings-interface">
            <div class="chat-header">
                <img src="https://i.postimg.cc/5yYPbtpG/wu-biao-ti19-20260103195316.png" class="chat-header-icon" onclick="closeMiyoSettings()">
                <div class="chat-header-title">Miyo设置</div>
                <div style="width:24px;"></div> 
            </div>
            <div class="settings-content">
                <div class="settings-section">
                    <!-- 修改：删除旧选项，新增用户预设 -->
                    <div class="wx-cell" onclick="openUserPresetsInterface()">
                        <div class="wx-cell-text">用户预设</div>
                        <div class="wx-cell-arrow"><i class="fas fa-chevron-right"></i></div>
                    </div>
                </div>
            </div>
        </div>

            <!-- 新增：用户预设界面 -->
            <div id="user-presets-interface">
                <div class="chat-header">
                    <img src="https://i.postimg.cc/5yYPbtpG/wu-biao-ti19-20260103195316.png" class="chat-header-icon" onclick="closeUserPresetsInterface()">
                    <div class="chat-header-title">用户预设</div>
                    <img src="https://i.postimg.cc/sgy4rgBh/wu-biao-ti19-20260102063856.png" class="chat-header-icon" onclick="openAddPresetModal()">
                </div>
                <div class="wb-content" id="userPresetsContent">
                    <!-- 用户预设列表 -->
                </div>
            </div>


            <!-- 弹窗覆盖层 -->
            <div class="modal-overlay" id="modalOverlay"></div>

            <!-- 1. 菜单弹窗 -->
            <div class="bottom-modal" id="modalMenu">
                <img src="https://i.postimg.cc/dthz5H9B/wu-biao-ti19-20260103184734.png" class="close-btn" onclick="closeAllModals()">
                <div style="margin-top: 40px;">
                    <div class="menu-btn" onclick="openRoleModal()">添加角色</div>
                    <div class="menu-btn" onclick="openGroupModal()">添加群聊</div>
                </div>
            </div>

            <!-- 2. 添加角色 -->
            <div class="bottom-modal" id="modalAddRole">
                <img src="https://i.postimg.cc/dthz5H9B/wu-biao-ti19-20260103184734.png" class="close-btn" onclick="closeRoleModal()">
                <div class="modal-form-content">
                    <div class="avatar-edit-container" onclick="openAvatarSettings('role')">
                        <img id="roleAvatarPreview" src="">
                    </div>
                    <div class="form-group"><span class="form-label">角色真名</span><input type="text" class="form-input" id="inputRoleRealName"></div>
                    <div class="form-group"><span class="form-label">角色Miyo名</span><input type="text" class="form-input" id="inputRoleMiyoName"></div>
                    <div class="form-group"><span class="form-label">给角色的备注</span><input type="text" class="form-input" id="inputRoleRemark"></div>
                    <div class="form-group"><span class="form-label">角色Miyo号</span><input type="text" class="form-input" id="inputRoleID"></div>
                    <div class="form-group"><span class="form-label">角色签名</span><input type="text" class="form-input" id="inputRoleSign"></div>
                    <div class="form-group"><span class="form-label">角色人设</span><textarea class="form-textarea" id="inputRolePersona"></textarea></div>
                    <div class="save-btn" onclick="saveNewRole()">保存</div>
                </div>
            </div>

            <!-- 3. 添加群聊 -->
            <div class="bottom-modal" id="modalAddGroup">
                <img src="https://i.postimg.cc/dthz5H9B/wu-biao-ti19-20260103184734.png" class="close-btn" onclick="closeGroupModal()">
                <div class="modal-form-content">
                    <div class="avatar-edit-container" onclick="openAvatarSettings('group')">
                        <img id="groupAvatarPreview" src="">
                    </div>
                    <div class="form-group"><span class="form-label">群聊名称</span><input type="text" class="form-input" id="inputGroupName"></div>
                    <div class="form-group"><span class="form-label">选择角色加入群聊</span><div class="member-select-list" id="groupMemberSelect"><div style="text-align:center;color:#999;font-size:12px;padding:10px;">暂无添加的角色</div></div></div>
                    <div class="save-btn" onclick="saveNewGroup()">保存</div>
                </div>
            </div>

            <!-- 4. 设置头像 -->
            <div class="bottom-modal avatar-modal-bottom" id="modalAvatarSettings">
                <img src="https://i.postimg.cc/dthz5H9B/wu-biao-ti19-20260103184734.png" class="close-btn" onclick="closeAvatarSettings()">
                <div class="form-group"><span class="form-label">通过URL上传</span><input type="text" class="form-input" id="inputAvatarUrl" oninput="previewUrlAvatar(this.value)" placeholder="输入图片链接..."></div>
                <div class="upload-local-btn" onclick="document.getElementById('fileInput').click()">本地图片上传</div>
                <input type="file" id="fileInput" accept="image/*" style="display:none" onchange="previewLocalAvatar(this)">
                <div class="avatar-preview"><img id="avatarSettingPreview" src=""></div>
                <div class="save-btn" onclick="saveAvatarChange()">保存</div>
            </div>

            <!-- 5. 删除确认弹窗 (聊天记录) -->
            <div class="bottom-modal" id="modalDeleteConfirm">
                 <img src="https://i.postimg.cc/dthz5H9B/wu-biao-ti19-20260103184734.png" class="close-btn" onclick="closeDeleteConfirm()">
                 <div class="delete-confirm-content">
                     <div class="delete-text">此操作会删除这个角色所有的聊天记录，确定吗？</div>
                     <div class="save-btn" onclick="performDeleteHistory()">确定</div>
                 </div>
            </div>
            
            <!-- 15. 新增：聊天列表左滑删除确认弹窗 -->
            <div class="bottom-modal" id="modalDeleteChatListConfirm">
                 <img src="https://i.postimg.cc/dthz5H9B/wu-biao-ti19-20260103184734.png" class="close-btn" onclick="closeDeleteChatListConfirm()">
                 <div class="delete-confirm-content">
                     <div class="delete-text">此操作会删除和这个角色的所有聊天记录，确定吗？</div>
                     <div class="save-btn" style="background-color: black; color: white;" onclick="performDeleteChatList()">确定</div>
                 </div>
            </div>

            <!-- 6. 分组设置弹窗 -->
            <div class="bottom-modal" id="modalGroupSettings">
                <img src="https://i.postimg.cc/dthz5H9B/wu-biao-ti19-20260103184734.png" class="close-btn" onclick="closeGroupSettingsModal()">
                <div class="modal-form-content">
                    <div style="font-weight:600; font-size:16px; margin-left:16px;">分组</div>
                    <div class="member-select-list" id="wbGroupList" style="margin: 0 16px;">
                        <!-- 分组列表 -->
                    </div>
                    <div class="form-group" style="margin-top:10px;"><span class="form-label">添加分组</span><input type="text" class="form-input" id="inputWBGroupName"></div>
                    <div class="black-btn" style="margin: 10px 16px;" onclick="addWBGroup()">添加</div>
                </div>
            </div>

            <!-- 7. 添加世界书弹窗 -->
            <div class="bottom-modal" id="modalAddWorldBook">
                <img src="https://i.postimg.cc/dthz5H9B/wu-biao-ti19-20260103184734.png" class="close-btn" onclick="closeAddWorldBookModal()">
                <div class="modal-form-content">
                    <div class="form-group"><span class="form-label">世界书名字</span><input type="text" class="form-input" id="inputWBName"></div>
                    <div class="form-group">
                        <span class="form-label">分组</span>
                        <div class="relative-wrapper">
                            <div class="custom-select-container" id="wbGroupSelectDisplay" onclick="toggleWBGroupSelect()">
                                <span>请选择分组</span>
                                <i class="fas fa-chevron-right rotate-icon" id="icon-wb-group-select"></i>
                            </div>
                            <div class="member-select-list hidden dropdown-list" id="wbGroupSelectOptions"></div>
                        </div>
                    </div>
                    <div class="form-group"><span class="form-label">世界书内容</span><textarea class="form-textarea" style="height:150px;" id="inputWBContent"></textarea></div>
                    <div class="black-btn" style="margin: 20px 16px;" onclick="saveNewWorldBook()">保存</div>
                </div>
            </div>

            <!-- 8. 绑定世界书弹窗 -->
            <div class="bottom-modal" id="modalBindWorldBook">
                <img src="https://i.postimg.cc/dthz5H9B/wu-biao-ti19-20260103184734.png" class="close-btn" onclick="closeBindWorldBookModal()">
                <div class="modal-form-content">
                    <div class="form-group">
                        <span class="form-label">分组</span>
                        <div class="relative-wrapper">
                            <div class="custom-select-container" id="bindGroupSelectDisplay" onclick="toggleBindGroupSelect()">
                                <span>请选择分组</span>
                                <i class="fas fa-chevron-right rotate-icon" id="icon-bind-group-select"></i>
                            </div>
                            <div class="member-select-list hidden dropdown-list" id="bindGroupSelectOptions"></div>
                        </div>
                    </div>

                    <div class="form-group" style="margin-top:20px;">
                        <span class="form-label">已绑定的世界书</span>
                        <div class="bound-books-display" id="boundBooksDisplayArea">
                            <span style="color:#999; font-size:14px;">暂无</span>
                        </div>
                    </div>

                    <div class="form-group" style="margin-top:20px;">
                        <span class="form-label">选择世界书 (可多选)</span>
                        <div class="member-select-list" id="bindBookList" style="height:200px;"></div>
                    </div>
                    <div class="black-btn" style="margin: 20px 16px;" onclick="saveBindWorldBook()">保存</div>
                </div>
            </div>

            <!-- 9. 编辑世界书弹窗 -->
            <div class="bottom-modal" id="modalEditWorldBook">
                <img src="https://i.postimg.cc/dthz5H9B/wu-biao-ti19-20260103184734.png" class="close-btn" onclick="closeEditWorldBookModal()">
                <div class="modal-form-content">
                    <div class="form-group"><span class="form-label">世界书名字</span><input type="text" class="form-input" id="editWBName"></div>
                    
                    <div class="form-group">
                        <span class="form-label">分组</span>
                        <div class="relative-wrapper">
                            <div class="custom-select-container" id="editWBGroupSelectDisplay" onclick="toggleEditWBGroupSelect()">
                                <span>请选择分组</span>
                                <i class="fas fa-chevron-right rotate-icon" id="icon-edit-wb-group-select"></i>
                            </div>
                            <div class="member-select-list hidden dropdown-list" id="editWBGroupSelectOptions"></div>
                        </div>
                    </div>

                    <div class="form-group"><span class="form-label">世界书内容</span><textarea class="form-textarea" style="height:150px;" id="editWBContent"></textarea></div>
                    <div class="black-btn" style="margin: 20px 16px;" onclick="saveEditedWorldBook()">保存</div>
                </div>
            </div>

            <!-- 10. 删除世界书确认弹窗 -->
            <div class="bottom-modal" id="modalDeleteWBConfirm">
                 <img src="https://i.postimg.cc/dthz5H9B/wu-biao-ti19-20260103184734.png" class="close-btn" onclick="closeDeleteWBConfirm()">
                 <div class="delete-confirm-content">
                     <div class="delete-text" id="deleteWBConfirmText">此操作会将“世界书名称”世界书删除，确定吗？</div>
                     <div class="save-btn" onclick="performDeleteWB()">确定</div>
                 </div>
            </div>

            <!-- 11. 删除成功居中弹窗 -->
            <div class="center-modal" id="modalSuccessCenter">
                <div style="font-size:18px; font-weight:600; margin-bottom:20px;">删除成功</div>
                <div class="black-btn" style="width:100%; margin:0;" onclick="closeSuccessModal()">确认</div>
            </div>

            <!-- 12. 请填写完整信息居中弹窗 -->
            <div class="center-modal" id="modalIncompleteInfo">
                <div style="font-size:18px; font-weight:600; margin-bottom:20px;">请填写完整信息</div>
                <div class="black-btn" style="width:100%; margin:0;" onclick="closeIncompleteInfoModal()">确认</div>
            </div>

            <!-- 13. 删除角色确认弹窗 -->
            <div class="bottom-modal" id="modalDeleteRoleConfirm">
                 <img src="https://i.postimg.cc/dthz5H9B/wu-biao-ti19-20260103184734.png" class="close-btn" onclick="closeDeleteRoleConfirm()">
                 <div class="delete-confirm-content">
                     <div class="delete-text">此操作会完全删除这个角色，确定吗？</div>
                     <div class="save-btn" onclick="performDeleteRole()">确定</div>
                 </div>
            </div>

            <!-- 14. 删除群聊确认弹窗 -->
            <div class="bottom-modal" id="modalDeleteGroupConfirm">
                 <img src="https://i.postimg.cc/dthz5H9B/wu-biao-ti19-20260103184734.png" class="close-btn" onclick="closeDeleteGroupConfirm()">
                 <div class="delete-confirm-content">
                     <div class="delete-text">此操作会完全删除这个群聊，确定吗？</div>
                     <div class="save-btn" onclick="performDeleteGroup()">确定</div>
                 </div>
            </div>

            <!-- 16. 新增：添加/编辑用户预设弹窗 -->
            <div class="bottom-modal" id="modalUserPreset">
                <img src="https://i.postimg.cc/dthz5H9B/wu-biao-ti19-20260103184734.png" class="close-btn" onclick="closeUserPresetModal()">
                <div class="modal-form-content">
                    <div class="avatar-edit-container" onclick="openAvatarSettings('preset')">
                        <img id="presetAvatarPreview" src="">
                    </div>
                    <div class="form-group"><span class="form-label">用户真名</span><input type="text" class="form-input" id="inputPresetRealName"></div>
                    <div class="form-group"><span class="form-label">用户Miyo名</span><input type="text" class="form-input" id="inputPresetMiyoName"></div>
                    <div class="form-group"><span class="form-label">用户Miyo号</span><input type="text" class="form-input" id="inputPresetMiyoID"></div>
                    <div class="form-group"><span class="form-label">用户签名</span><input type="text" class="form-input" id="inputPresetSign"></div>
                    <div class="form-group"><span class="form-label">用户人设</span><textarea class="form-textarea" id="inputPresetPersona"></textarea></div>
                    <div class="save-btn" style="background-color: #000; color: #fff;" onclick="saveUserPreset()">保存</div>
                </div>
            </div>

            <!-- 17. 新增：删除用户预设确认弹窗 -->
            <div class="bottom-modal" id="modalDeletePresetConfirm">
                 <img src="https://i.postimg.cc/dthz5H9B/wu-biao-ti19-20260103184734.png" class="close-btn" onclick="closeDeletePresetConfirm()">
                 <div class="delete-confirm-content">
                     <div class="delete-text">此操作会删除这个用户预设，确定吗？</div>
                     <div class="save-btn" style="background-color: #000; color: #fff;" onclick="performDeletePreset()">确定</div>
                 </div>
            </div>
<!-- 18. 新增：选择用户预设弹窗 -->
            <div class="bottom-modal" id="modalSelectUserPreset">
                <img src="https://i.postimg.cc/dthz5H9B/wu-biao-ti19-20260103184734.png" class="close-btn" onclick="closeSelectUserPresetModal()">
                <div class="modal-form-content">
                    <div style="font-weight:600; font-size:18px; margin-left:16px; margin-bottom:10px;">选择用户预设</div>
                    
                    <!-- 预设列表容器 -->
                    <div id="selectUserPresetListContainer" style="max-height: 50vh; overflow-y: auto; padding: 0 16px;">
                        <!-- JS 动态生成内容 -->
                    </div>

                    <div class="save-btn" style="background-color: #000; color: #fff;" onclick="confirmSelectUserPreset()">保存</div>
                </div>
            </div>
            <!-- 19. 新增：删除用户预设确认弹窗 (带名字) -->
            <div class="bottom-modal" id="modalDeletePresetConfirmWithName">
                 <img src="https://i.postimg.cc/NfcMRH08/wu-biao-ti19-20260103184734.png" class="close-btn" onclick="closeDeletePresetConfirmWithName()">
                 <div class="delete-confirm-content">
                     <div class="delete-text" id="deletePresetConfirmText">此操作会完全删除该预设，确定吗？</div>
                     <div class="save-btn" style="background-color: #000; color: #fff;" onclick="performDeletePresetWithName()">确定</div>
                 </div>
            </div>

            <!-- 20. 新增：设置显示成功弹窗 -->
            <div class="center-modal" id="modalSetDisplaySuccess">
                <div style="font-size:18px; font-weight:600; margin-bottom:10px;">设置成功</div>
                <div style="font-size:14px; color:#666; margin-bottom:20px; text-align:center;">请返回“我”查看</div>
                <div class="black-btn" style="width:100%; margin:0;" onclick="closeSetDisplaySuccessModal()">确认</div>
            </div>
            <!-- 21. 新增：删除世界书分组确认弹窗 -->
            <div class="bottom-modal" id="modalDeleteWBGroupConfirm" style="z-index: 650;"> <!-- z-index 设高一点，盖住下面的弹窗 -->
                 <img src="https://i.postimg.cc/NfcMRH08/wu-biao-ti19-20260103184734.png" class="close-btn" onclick="closeDeleteWBGroupConfirm()">
                 <div class="delete-confirm-content">
                     <div class="delete-text" id="deleteWBGroupConfirmText">此操作会删除“分组名称”该世界书分组，确定吗？</div>
                     <div class="save-btn" style="background-color: #000; color: #fff;" onclick="performDeleteWBGroup()">确定</div>
                 </div>
            </div>
            <!-- 22. 表情包主弹窗 (Level 1) -->
            <div class="bottom-modal" id="modalStickers" style="z-index: 610; height: 50vh; max-height: 50vh;">
                <div class="chat-header" style="position:relative; top:0; left:0; right:0; width:100%; margin-bottom:10px; background:transparent; border:none; box-shadow:none;">
                                        <div class="sticker-modal-header-left">
                        <span class="sticker-header-btn sticker-btn-black" onclick="document.getElementById('file-upload-sticker').click()">本地上传</span>
                        <span class="sticker-header-btn sticker-btn-black" onclick="openStickerImportTypeModal()">url链接</span>
                        <span class="sticker-header-btn sticker-btn-red" onclick="toggleStickerDeleteMode()" id="btn-sticker-delete-mode">删除</span>
                    </div>
                    <!-- 退出按钮 (删除模式下隐藏) -->
                    <img src="https://i.postimg.cc/NfcMRH08/wu-biao-ti19-20260103184734.png" class="close-btn" id="btn-close-sticker-modal" style="position:relative; top:0; right:0;" onclick="closeStickerModal()">
                </div>
                
                <div id="stickerGridContent" style="flex:1; overflow-y:auto;">
                    <!-- 表情包列表 -->
                </div>

                <!-- 删除模式底部栏 (默认隐藏) -->
                <div class="sticker-modal-footer" id="stickerDeleteFooter" style="display:none;">
                    <div class="text-btn cancel" onclick="toggleStickerDeleteMode()">取消</div>
                    <div class="text-btn delete" onclick="openDeleteStickersConfirm()">删除</div>
                </div>
            </div>

            <!-- 23. 表情包导入类型选择弹窗 (Level 2) -->
            <div class="bottom-modal" id="modalStickerImportType" style="z-index: 620;">
                <img src="https://i.postimg.cc/NfcMRH08/wu-biao-ti19-20260103184734.png" class="close-btn" onclick="closeStickerImportTypeModal()">
                <div class="modal-form-content" style="margin-top: 40px;">
                    <div class="menu-btn" onclick="openSingleImportModal()">单个导入</div>
                    <div class="menu-btn" onclick="openBatchImportModal()">批量导入</div>
                </div>
            </div>

            <!-- 24. 单个导入表情包弹窗 (Level 3) -->
            <div class="bottom-modal" id="modalStickerSingleImport" style="z-index: 630;">
                <img src="https://i.postimg.cc/NfcMRH08/wu-biao-ti19-20260103184734.png" class="close-btn" onclick="closeSingleImportModal()">
                <div class="modal-form-content">
                    <div class="form-group"><span class="form-label">url链接</span><input type="text" class="form-input" id="inputStickerUrl" oninput="previewStickerUrl(this.value)"></div>
                    <div class="form-group"><span class="form-label">文字描述</span><input type="text" class="form-input" id="inputStickerDesc"></div>
                    <div class="form-group"><span class="form-label">预览</span><img id="stickerUrlPreview" class="preview-box-large" src=""></div>
                    <div class="save-btn" onclick="saveSingleSticker()">保存</div>
                </div>
            </div>

            <!-- 25. 批量导入表情包弹窗 (Level 3) -->
            <div class="bottom-modal" id="modalStickerBatchImport" style="z-index: 630;">
                <img src="https://i.postimg.cc/NfcMRH08/wu-biao-ti19-20260103184734.png" class="close-btn" onclick="closeBatchImportModal()">
                <div class="modal-form-content">
                    <div class="form-group">
                        <span class="form-label">批量导入</span>
                        <textarea class="form-textarea" id="inputStickerBatch" style="height:200px;" placeholder="批量导入格式：&#10;1.文字描述：url链接&#10;2.文字描述:url链接&#10;3.文字描述 url链接"></textarea>
                    </div>
                    <div class="save-btn" onclick="saveBatchStickers()">保存</div>
                </div>
            </div>

            <!-- 26. 本地上传确认弹窗 (Level 2) -->
            <div class="bottom-modal" id="modalStickerLocalConfirm" style="z-index: 620;">
                <img src="https://i.postimg.cc/NfcMRH08/wu-biao-ti19-20260103184734.png" class="close-btn" onclick="closeLocalStickerModal()">
                <div class="modal-form-content">
                    <div class="form-group"><span class="form-label">文字描述</span><input type="text" class="form-input" id="inputLocalStickerDesc"></div>
                    <div class="form-group"><span class="form-label">表情包预览</span><img id="stickerLocalPreview" class="preview-box-large" src=""></div>
                    <div class="save-btn" onclick="saveLocalSticker()">保存</div>
                </div>
            </div>

            <!-- 27. 删除表情包确认弹窗 (Level 2) -->
            <div class="bottom-modal" id="modalDeleteStickersConfirm" style="z-index: 620;">
                 <img src="https://i.postimg.cc/NfcMRH08/wu-biao-ti19-20260103184734.png" class="close-btn" onclick="closeDeleteStickersConfirm()">
                 <div class="delete-confirm-content">
                     <div class="delete-text">此操作会删除已选择的表情包，确定吗？</div>
                     <div class="save-btn" onclick="performDeleteStickers()">确定</div>
                 </div>
            </div>

            <!-- 隐藏的文件上传 input -->
            <input type="file" id="file-upload-sticker" accept="image/*" hidden onchange="handleStickerFile(this)">
        <div class="desktop-mask" id="desktopMask">
            <div class="desktop-slider" id="desktopSlider">
                
                <!-- Page 1 -->
                <div class="desktop-page">
                    <div class="widget-area text-light-mode">
                        <div class="big-clock">
                            <div class="big-time" id="widget-time">12:00</div>
                            <div class="big-date" id="widget-date">1月1日 星期一</div>
                        </div>
                    </div>
                    <div class="home-screen">
                        <div class="app-item" onclick="openApp()"><img src="https://i.postimg.cc/bYF0NdSH/f9d3f4da6rcb3778c460a508f774d0c0.png" class="app-icon"><span class="app-name text-light-mode">Miyo</span></div>
                        <div class="app-item"><img src="https://i.postimg.cc/MZr0KXfr/01d72cb81uf0893917bd3e817159d78f.png" class="app-icon"><span class="app-name text-light-mode">天气</span></div>
                        <div class="app-item"><img src="https://i.postimg.cc/44FvNnHB/0f12d0409i1f4fd05c3ad428704a2eeb.png" class="app-icon"><span class="app-name text-light-mode">日历</span></div>
                        <div class="app-item"><img src="https://i.postimg.cc/pV1QXy5k/1eff53751rdf1216f32f56fe97dde044.png" class="app-icon"><span class="app-name text-light-mode">照片</span></div>
                        <div class="app-item"><img src="https://i.postimg.cc/kMhNXDRs/255fa986br39273b8e87fbec5bb854f6.png" class="app-icon"><span class="app-name text-light-mode">相机</span></div>
                        <div class="app-item"><img src="https://i.postimg.cc/TYLVyGnN/261ebb423n8c072ee9ae2acb96410c0b.png" class="app-icon"><span class="app-name text-light-mode">邮件</span></div>
                        <div class="app-item"><img src="https://i.postimg.cc/59k5NjQT/2b890a157m474c436edf3276ca96fc2b.png" class="app-icon"><span class="app-name text-light-mode">备忘录</span></div>
                        <div class="app-item" onclick="openSettings()"><img src="https://i.postimg.cc/HscwJHbS/453aa5f9bl4b479c54b6f5b5776254d8.png" class="app-icon"><span class="app-name text-light-mode">设置</span></div>
                    </div>
                </div>

                <!-- Page 2 (Widgets) -->
                <div class="desktop-page">
                    <div class="widget-board">
                        <div class="app-pair grid-pos-top-left">
                            <div class="app-item"><img src="https://i.postimg.cc/XNDK7XBh/dbc5aab4bl008aba0b02f261242ad8b6.png" class="app-icon"><span class="app-name">待办事项</span></div>
                            <div class="app-item"><img src="https://i.postimg.cc/zXbCL5Tc/ec1ee5b9cude8ff8a9b1c13da2ed4a8c.png" class="app-icon"><span class="app-name">音乐</span></div>
                        </div>
                        <div class="ios-widget glass-panel grid-pos-top-right">
                            <div class="cal-day" id="widget-cal-full-date">2025年1月1日 周一</div>
                            <div class="cal-big" id="widget-cal-day-num">1</div>
                            <div style="flex:1;"></div>
                            <div class="cal-event"><span class="cal-empty-text">请先添加待办事项</span></div>
                        </div>
                        <div class="ios-widget vinyl-widget grid-pos-bottom-left">
                            <div class="vinyl-disc"><div class="vinyl-label"></div><div class="vinyl-hole"></div></div>
                        </div>
                        <div class="app-pair grid-pos-bottom-right">
                             <div class="app-item"><img src="https://i.postimg.cc/BZw5QtPV/ee99cc934rafd15574b7e2b4f2f98519.png" class="app-icon"><span class="app-name">论坛</span></div>
                            <div class="app-item"><img src="https://i.postimg.cc/8PJRFDLw/f185d1a38hb03e0752380eb3121d3939.png" class="app-icon"><span class="app-name">单机游戏</span></div>
                        </div>
                    </div>
                    <div class="polaroid-group">
                        <div class="polaroid-card polaroid-1"><img src="https://images.unsplash.com/photo-1517849845537-4d257902454a?w=400&q=80" class="polaroid-img"></div>
                        <div class="polaroid-card polaroid-2"><img src="https://images.unsplash.com/photo-1543852786-1cf6624b9987?w=400&q=80" class="polaroid-img"></div>
                        <div class="polaroid-card polaroid-3"><img src="https://images.unsplash.com/photo-1493976040374-85c8e12f0c0e?w=400&q=80" class="polaroid-img"></div>
                    </div>
                </div>

            </div>
        </div>

        <div class="pagination text-light-mode">
            <div class="dot active"></div><div class="dot"></div>
        </div>

        <div class="dock-wrapper">
            <div class="dock-bg">
                <div class="app-item"><img src="https://i.postimg.cc/3J4Xy72b/484d80ddahda8e0462e31693fa06db5e.png" class="app-icon"></div>
                <div class="app-item"><img src="https://i.postimg.cc/m2zYcR7X/9f9783b40gc9906d1037e49a18e56b37.png" class="app-icon"></div>
                <div class="app-item"><img src="https://i.postimg.cc/YqG64kQd/a27d8264fv991e8df1dbeb536e03d280.png" class="app-icon"></div>
                <div class="app-item"><img src="https://i.postimg.cc/MZr0KXfD/c59a4491duee7b2072eb2c09bf5dd8ae.png" class="app-icon"></div>
            </div>
        </div>

        <div class="home-bar-area" onclick="handleHomeBarClick()"></div>
        <div class="home-bar"></div>
    </div>

    <script>
        let savedStickers = []; // 存储表情包数据
        // 修复：将 currentDesktop 声明提前，防止变量提升问题
        let currentDesktop = 0; 
        
        const wallpaperColors = { statusBar: 'light', clock: 'light', icons: 'light', dots: 'light', homeBar: 'light' };
        
        // 将默认壁纸设为空，配合CSS的 background-color: #fff 实现纯白
        let page1Url = ''; 
        let page2Url = '';

    // 存储两个桌面的文字颜色模式：'light' (白字) 或 'dark' (黑字)
    let desktopTextModes = ['dark', 'dark']; 
        
        // 修改：新的默认头像URL
        const DEFAULT_AVATAR = 'https://i.postimg.cc/TPSZtKjJ/IMG-1077.png';
        const OLD_TRANSPARENT_AVATAR = "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7";

          const bgLayer1 = document.getElementById('bg-layer-1');
        const bgLayer2 = document.getElementById('bg-layer-2');
        
        // 初始化时，如果有链接则加载，没有则保持纯白
        // (这部分逻辑会在后面的 loadDesktopSettings 中被覆盖，但为了安全先保留为空)
        bgLayer1.style.backgroundImage = 'none';
        bgLayer2.style.backgroundImage = 'none';

        function updateTime() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            
            const timeStr = hours + ":" + minutes;
            document.getElementById('status-clock').innerText = timeStr;
            document.getElementById('widget-time').innerText = timeStr;
            
            const days = ['周日', '周一', '周二', '周三', '周四', '周五', '周六'];
            const month = now.getMonth() + 1;
            const date = now.getDate();
            const dayName = days[now.getDay()];
            const year = now.getFullYear();
            
            const dateStr = month + "月" + date + "日 " + dayName;
            document.getElementById('widget-date').innerText = dateStr;
            
            const fullDateStr = year + "年" + month + "月" + date + "日  " + dayName;
            
            const calFullDate = document.getElementById('widget-cal-full-date');
            const calDayNum = document.getElementById('widget-cal-day-num');
            if(calFullDate) calFullDate.innerText = fullDateStr;
            if(calDayNum) calDayNum.innerText = date;
        }
        setInterval(updateTime, 1000);
        updateTime();

        function getAverageBrightness(ctx, x, y, width, height) {
            try {
                if (x < 0) x = 0; if (y < 0) y = 0;
                const imageData = ctx.getImageData(x, y, width, height);
                const data = imageData.data;
                let r = 0, g = 0, b = 0, count = 0;
                for (let i = 0; i < data.length; i += 40) { 
                    r += data[i]; 
                    g += data[i+1]; 
                    b += data[i+2]; 
                    count++; 
                }
                if (count === 0) return 0;
                r = Math.floor(r / count); 
                g = Math.floor(g / count); 
                b = Math.floor(b / count);
                return (r * 299 + g * 587 + b * 114) / 1000;
            } catch (e) { 
                console.warn("Canvas Access Error", e); 
                return 0; 
            }
        }

                        // 计算指定图片的亮度，并更新对应页面的模式
        function calculatePageColorMode(imgUrl, pageIndex) {
            // 1. 如果是空URL（纯白背景），直接设为深色模式（黑字）
            if (!imgUrl || imgUrl === '') {
                desktopTextModes[pageIndex] = 'dark';
                if (currentDesktop === pageIndex) applyCurrentDesktopStyle();
                return;
            }

            const img = new Image();
            img.crossOrigin = "Anonymous";
            img.src = imgUrl;
            
            img.onload = function() {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                // 缩小尺寸以加快计算速度
                canvas.width = 100; 
                canvas.height = 100;
                ctx.drawImage(img, 0, 0, 100, 100);
                
                // 获取顶部区域（状态栏）的平均亮度
                // 简单取前 20% 的高度
                const imageData = ctx.getImageData(0, 0, 100, 20);
                const data = imageData.data;
                let r, g, b, avg;
                let colorSum = 0;
                
                for (let i = 0, len = data.length; i < len; i += 4) {
                    r = data[i];
                    g = data[i+1];
                    b = data[i+2];
                    avg = Math.floor((r + g + b) / 3);
                    colorSum += avg;
                }
                
                const brightness = Math.floor(colorSum / (data.length / 4));
                
                // 亮度 > 180 认为是浅色背景 -> 用深色文字(dark)
                // 亮度 < 180 认为是深色背景 -> 用浅色文字(light)
                desktopTextModes[pageIndex] = brightness > 180 ? 'dark' : 'light';
                
                // 如果当前正好显示这个页面，立即应用
                if (currentDesktop === pageIndex) {
                    applyCurrentDesktopStyle();
                }
            };

            img.onerror = function() {
                // 加载失败兜底为黑字
                desktopTextModes[pageIndex] = 'dark';
                if (currentDesktop === pageIndex) applyCurrentDesktopStyle();
            };
        }

        // 应用当前桌面的颜色样式
        function applyCurrentDesktopStyle() {
            const mode = desktopTextModes[currentDesktop]; // 获取当前页面的模式
            
            // 1. 设置状态栏
            updateStatusBar(mode === 'light' ? 'light' : 'dark');
            
            // 2. 设置 Home Bar
            updateHomeBar(mode === 'light' ? 'light' : 'dark');
            
            // 3. 设置桌面元素文字颜色
            const widget = document.querySelector('.widget-area');
            const appNames = document.querySelectorAll('.app-name');
            const pagination = document.querySelector('.pagination');
            
            // 移除旧类
            if(widget) widget.classList.remove('text-light-mode', 'text-dark-mode');
            appNames.forEach(name => name.classList.remove('text-light-mode', 'text-dark-mode'));
            if(pagination) pagination.classList.remove('text-light-mode', 'text-dark-mode');
            
            // 添加新类
            const classToAdd = mode === 'light' ? 'text-light-mode' : 'text-dark-mode';
            
            if(widget) widget.classList.add(classToAdd);
            appNames.forEach(name => name.classList.add(classToAdd));
            if(pagination) pagination.classList.add(classToAdd);
        }

        function applyWallpaperColors() {
            const widget = document.querySelector('.widget-area');
            const appNames = document.querySelectorAll('.app-name');
            const pagination = document.querySelector('.pagination');
            widget.classList.remove('text-light-mode', 'text-dark-mode');
            widget.classList.add(wallpaperColors.clock === 'light' ? 'text-light-mode' : 'text-dark-mode');
            appNames.forEach(name => {
                name.classList.remove('text-light-mode', 'text-dark-mode');
                name.classList.add(wallpaperColors.icons === 'light' ? 'text-light-mode' : 'text-dark-mode');
            });
            pagination.classList.remove('text-light-mode', 'text-dark-mode');
            pagination.classList.add(wallpaperColors.dots === 'light' ? 'text-light-mode' : 'text-dark-mode');
            const appDisplay = document.getElementById('wechat-app').style.display;
            const settingsActive = document.getElementById('settings-interface').classList.contains('active');
            if (appDisplay !== 'flex' && !settingsActive) {
                updateStatusBar(wallpaperColors.statusBar);
                updateHomeBar(wallpaperColors.homeBar);
            }
        }

        function updateStatusBar(mode) {
            const sb = document.getElementById('statusBar');
            sb.classList.remove('light-content', 'dark-content');
            sb.classList.add(mode === 'light' ? 'light-content' : 'dark-content');
        }

        function updateHomeBar(mode) {
            const hb = document.querySelector('.home-bar');
            if (mode === 'light') hb.style.backgroundColor = 'white';
            else hb.style.backgroundColor = '#111';
        }

        function checkAppStatusBarContrast() {
            updateStatusBar('dark');
            updateHomeBar('dark'); 
        }

                                function handleHomeBarClick() {
            // 1. 强制关闭所有弹窗
            closeAllModals();

            // 获取各个界面的元素
            const app = document.getElementById('wechat-app');
            const settings = document.getElementById('settings-interface');
            const miyoSettings = document.getElementById('miyo-settings-interface');
            const userPresets = document.getElementById('user-presets-interface');

            // 2. 最小化 App 界面
            if (app.style.display === 'flex') {
                app.style.display = 'none';
                miyoSettings.style.display = 'none';
                userPresets.style.display = 'none';
            }

            // 最小化全局设置界面
            if (settings.classList.contains('active')) {
                settings.style.display = 'none';
            }

            // 3. 修改这里：恢复状态栏和小白条颜色为当前桌面的样式
            applyCurrentDesktopStyle();
        }

                        function openApp() {
            // 1. 显示主 App 窗口
            document.getElementById('wechat-app').style.display = 'flex';
            
            // 2. 恢复子界面（Miyo设置、用户预设）的显示状态
            const miyoSettings = document.getElementById('miyo-settings-interface');
            const userPresets = document.getElementById('user-presets-interface');
            
            if (miyoSettings.classList.contains('active')) {
                miyoSettings.style.display = 'flex';
            }
            if (userPresets.classList.contains('active')) {
                userPresets.style.display = 'flex';
            }

            checkAppStatusBarContrast(); 
            
            // 3. 核心修复：获取当前处于激活状态的标签页索引，并刷新 UI
            // 这样既保留了用户所在的页面，又确保了顶部栏（搜索框、标题）显示正确
            let activeIndex = 0;
            const tabs = document.querySelectorAll('.tab-item');
            tabs.forEach((tab, index) => {
                if (tab.classList.contains('active')) {
                    activeIndex = index;
                }
            });
            
            // 重新运行一次 switchTab 逻辑来校准顶部栏
            switchTab(activeIndex);
        }

                function closeApp() {
            document.getElementById('wechat-app').style.display = 'none';
            
            // 修改这里：使用新的函数来恢复当前桌面的颜色
            applyCurrentDesktopStyle();
        }

        function toggleGroup(id) {
            const c = document.getElementById('content-'+id), i = document.getElementById('icon-'+id);
            if(c){ if(c.classList.contains('show')){ c.classList.remove('show'); if(i)i.classList.remove('down'); } else { c.classList.add('show'); if(i)i.classList.add('down'); } }
        }
        
        function switchTab(index) {
            const tabs = document.querySelectorAll('.tab-item'); tabs.forEach(t => t.classList.remove('active')); tabs[index].classList.add('active');
            const pages = document.querySelectorAll('.tab-page'); pages.forEach(p => p.classList.remove('active')); pages[index].classList.add('active');
            const header = document.getElementById('wx-header'); const meCard = document.getElementById('me-header-card');
            const title = document.getElementById('wx-title'); const search = document.getElementById('wx-header-search');
            const rightIcon = document.getElementById('wx-right-icon'); 
            header.style.display = (index === 3) ? 'none' : 'flex';
            meCard.style.display = (index === 3) ? 'flex' : 'none';
            
              let baseTop = '175px';
            if (index === 3) {
                baseTop = '210px'; // "我" 页面，因为有个人卡片
            } else if (index === 2) {
                baseTop = '140px'; // "探索" 页面，因为没有搜索框
            } else {
                baseTop = '175px'; // "Miyo" 和 "联系人" 页面
            }
            document.documentElement.style.setProperty('--wx-body-base-top', baseTop);
            
            rightIcon.onclick = null;
            if(index !== 3) {
                if(index === 0) { 
                    title.innerText = "Miyo"; 
                    search.style.display = 'block'; 
                    rightIcon.style.display = 'none'; 
                    renderRecentChats(); 
                }
                else if(index === 1) { 
                    title.innerText = "联系人"; 
                    search.style.display = 'block'; 
                    rightIcon.style.display = 'block'; 
                    rightIcon.src = "https://i.postimg.cc/sgy4rgBh/wu-biao-ti19-20260102063856.png"; 
                    rightIcon.onclick = openAddMenu;
                }
                else if(index === 2) { 
                    title.innerText = "探索"; 
                    search.style.display = 'none'; 
                    rightIcon.style.display = 'none'; 
                }
            }
        }

        /* --- 数据库逻辑 --- */
        let db;
        let addedRoles = [];
        let addedGroups = [];
        let addedWBGroups = [];
        let addedWBBooks = [];
        let userPresets = []; // 新增：用户预设

                function initDB() {
            return new Promise((resolve, reject) => {
                // 修改：版本号升级为 10
                const request = indexedDB.open("MiyoDB", 10);
                request.onupgradeneeded = function(event) {
                    db = event.target.result;
                    if (!db.objectStoreNames.contains('roles')) {
                        db.createObjectStore('roles', { keyPath: 'id' });
                    }
                    if (!db.objectStoreNames.contains('groups')) {
                        db.createObjectStore('groups', { keyPath: 'id' });
                    }
                    if (!db.objectStoreNames.contains('wb_groups')) {
                        db.createObjectStore('wb_groups', { keyPath: 'id' });
                    }
                    if (!db.objectStoreNames.contains('wb_books')) {
                        db.createObjectStore('wb_books', { keyPath: 'id' });
                    }
                    if (!db.objectStoreNames.contains('user_presets')) {
                        db.createObjectStore('user_presets', { keyPath: 'id' });
                    }
                    // 新增：表情包表
                    if (!db.objectStoreNames.contains('stickers')) {
                        db.createObjectStore('stickers', { keyPath: 'id' });
                    }
                };
                request.onsuccess = function(event) {
                    db = event.target.result;
                    resolve(db);
                };
                request.onerror = function(event) {
                    console.error("Database error: " + event.target.errorCode);
                    reject(event.target.errorCode);
                };
            });
        }

        function saveDataToDB(storeName, data) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], "readwrite");
                const objectStore = transaction.objectStore(storeName);
                const request = objectStore.put(data);
                
                transaction.oncomplete = () => {
                    resolve();
                };
                
                transaction.onerror = (e) => {
                    console.error("Save failed", e);
                    reject("Save failed");
                };
            });
        }

        function deleteDataFromDB(storeName, key) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], "readwrite");
                const objectStore = transaction.objectStore(storeName);
                const request = objectStore.delete(key);
                
                transaction.oncomplete = () => {
                    resolve();
                };
                
                transaction.onerror = (e) => reject("Delete failed");
            });
        }

        function loadDataFromDB() {
    // 修改：添加 'stickers' 到事务中
    const tx = db.transaction(['roles', 'groups', 'wb_groups', 'wb_books', 'user_presets', 'stickers'], 'readonly');
    
    const rolesStore = tx.objectStore('roles');
    rolesStore.getAll().onsuccess = (e) => {
        addedRoles = e.target.result || [];
        renderFriendsList();
        renderRecentChats();
    };

    const groupsStore = tx.objectStore('groups');
    groupsStore.getAll().onsuccess = (e) => {
        addedGroups = e.target.result || [];
        renderGroupsList();
    };

    const wbGroupsStore = tx.objectStore('wb_groups');
    wbGroupsStore.getAll().onsuccess = (e) => {
        addedWBGroups = e.target.result || [];
        if(addedWBGroups.length === 0) {
            const defaultGroup = { id: 1, name: "默认分组" };
            saveDataToDB('wb_groups', defaultGroup);
            addedWBGroups.push(defaultGroup);
        }
    };

    const wbBooksStore = tx.objectStore('wb_books');
    wbBooksStore.getAll().onsuccess = (e) => {
        addedWBBooks = e.target.result || [];
    };

    // 加载用户预设
    const presetsStore = tx.objectStore('user_presets');
    presetsStore.getAll().onsuccess = (e) => {
        userPresets = e.target.result || [];
    };

    // 加载表情包 - 现在可以正常工作了
    const stickersStore = tx.objectStore('stickers');
    stickersStore.getAll().onsuccess = (e) => {
        savedStickers = e.target.result || [];
    };
}

        function renderFriendsList() {
            const friendList = document.getElementById('content-friends');
            friendList.innerHTML = '';
            addedRoles.forEach(role => {
                const wrapper = document.createElement('div');
                wrapper.className = 'swipe-item-wrapper';
                
                const contentBox = document.createElement('div');
                contentBox.className = 'swipe-content-box';
                
                const avatarSrc = (role.avatar && role.avatar.length > 5 && role.avatar !== OLD_TRANSPARENT_AVATAR) ? role.avatar : DEFAULT_AVATAR;
                
                contentBox.innerHTML = '<div class="wx-cell-icon"><img src="' + avatarSrc + '"></div><div class="wx-cell-text">' + role.name + '</div>';
                contentBox.onclick = function() { openChatWindow(role); };

                const deleteBtn = document.createElement('div');
                deleteBtn.className = 'swipe-delete-btn';
                deleteBtn.innerText = '删除';
                deleteBtn.onclick = function(e) {
                    e.stopPropagation();
                    openDeleteRoleConfirm(role);
                };

                wrapper.appendChild(contentBox);
                wrapper.appendChild(deleteBtn);
                friendList.appendChild(wrapper);
            });
        }

        function renderGroupsList() {
            const groupList = document.getElementById('content-groups');
            groupList.innerHTML = '';
            addedGroups.forEach(group => {
                const wrapper = document.createElement('div');
                wrapper.className = 'swipe-item-wrapper';
                
                const contentBox = document.createElement('div');
                contentBox.className = 'swipe-content-box';
                
                const avatarSrc = (group.avatar && group.avatar.length > 5 && group.avatar !== OLD_TRANSPARENT_AVATAR) ? group.avatar : DEFAULT_AVATAR;

                contentBox.innerHTML = '<div class="wx-cell-icon"><img src="' + avatarSrc + '"></div><div class="wx-cell-text">' + group.name + '</div>';
                
                const deleteBtn = document.createElement('div');
                deleteBtn.className = 'swipe-delete-btn';
                deleteBtn.innerText = '删除';
                deleteBtn.onclick = function(e) {
                    e.stopPropagation();
                    openDeleteGroupConfirm(group);
                };

                wrapper.appendChild(contentBox);
                wrapper.appendChild(deleteBtn);
                groupList.appendChild(wrapper);
            });
        }

                function renderRecentChats() {
            const container = document.getElementById('recentChatList');
            container.innerHTML = '';
            
            const chattingRoles = addedRoles.filter(r => r.chatHistory && r.chatHistory.length > 0);
            
            chattingRoles.sort((a, b) => {
                if (a.isPinned && !b.isPinned) return -1;
                if (!a.isPinned && b.isPinned) return 1;
                
                const lastA = a.chatHistory[a.chatHistory.length - 1].timestamp;
                const lastB = b.chatHistory[b.chatHistory.length - 1].timestamp;
                return lastB - lastA;
            });

            chattingRoles.forEach(role => {
                const lastMsg = role.chatHistory[role.chatHistory.length - 1];
                
                const wrapper = document.createElement('div');
                wrapper.className = 'recent-chat-wrapper';
                
                // --- 修改：置顶样式逻辑 ---
                let pinIconHtml = '';
                if(role.isPinned) {
                    wrapper.classList.add('pinned-border');
                    // 添加置顶图标
                    pinIconHtml = '<img src="https://i.postimg.cc/6QmYK6KQ/IMG-1081.png" class="pin-icon-img">';
                }
                
                const contentBox = document.createElement('div');
                contentBox.className = 'recent-chat-content';
                contentBox.onclick = () => openChatWindow(role);
                
                const date = new Date(lastMsg.timestamp);
                const timeStr = String(date.getHours()).padStart(2,'0') + ":" + String(date.getMinutes()).padStart(2,'0');
                const avatarSrc = (role.avatar && role.avatar.length > 5 && role.avatar !== OLD_TRANSPARENT_AVATAR) ? role.avatar : DEFAULT_AVATAR;

                contentBox.innerHTML = `
                    <img src="${avatarSrc}" class="recent-chat-avatar">
                    <div class="recent-chat-info">
                        <div class="recent-chat-name">${role.name}</div>
                        <div class="recent-chat-msg">${lastMsg.content}</div>
                    </div>
                    <div class="recent-chat-time">${timeStr}</div>
                    ${pinIconHtml} 
                `;

                const topBtn = document.createElement('div');
                topBtn.className = 'swipe-top-btn';
                topBtn.innerText = role.isPinned ? '取消置顶' : '置顶';
                topBtn.onclick = (e) => {
                    e.stopPropagation();
                    togglePin(role.id);
                };

                const delBtn = document.createElement('div');
                delBtn.className = 'swipe-delete-btn';
                delBtn.innerText = '删除';
                delBtn.onclick = (e) => {
                    e.stopPropagation();
                    openDeleteChatListConfirm(role);
                };

                wrapper.appendChild(contentBox);
                wrapper.appendChild(topBtn);
                wrapper.appendChild(delBtn);
                container.appendChild(wrapper);
            });
        }

        async function togglePin(roleId) {
            const roleIndex = addedRoles.findIndex(r => r.id === roleId);
            if(roleIndex !== -1) {
                addedRoles[roleIndex].isPinned = !addedRoles[roleIndex].isPinned;
                await saveDataToDB('roles', addedRoles[roleIndex]);
                renderRecentChats();
            }
        }

        let chatListRoleToDelete = null;

        function openDeleteChatListConfirm(role) {
            chatListRoleToDelete = role;
            document.getElementById('modalOverlay').classList.add('show');
            document.getElementById('modalDeleteChatListConfirm').classList.add('show');
        }

        function closeDeleteChatListConfirm() {
            document.getElementById('modalDeleteChatListConfirm').classList.remove('show');
            if(!document.getElementById('modalSuccessCenter').classList.contains('show')) {
                document.getElementById('modalOverlay').classList.remove('show');
            }
            chatListRoleToDelete = null;
        }

        async function performDeleteChatList() {
            if(!chatListRoleToDelete) return;
            chatListRoleToDelete.chatHistory = [];
            await saveDataToDB('roles', chatListRoleToDelete);
            renderRecentChats();
            closeDeleteChatListConfirm();
            showSuccessModal();
        }

        window.onload = function() {
            initDB().then(() => { loadDataFromDB(); });
            loadApiSettings(); 
        };

                /* --- Miyo 内部独立设置界面逻辑 --- */
        function openMiyoSettings() {
            const el = document.getElementById('miyo-settings-interface');
            el.classList.add('active');
            // 强制显示，覆盖可能存在的 display: none
            el.style.display = 'flex';
        }

        function closeMiyoSettings() {
            const el = document.getElementById('miyo-settings-interface');
            el.classList.remove('active');
            // 核心修复：必须显式设为 none，否则残留的 flex 会导致无法关闭
            el.style.display = 'none';
        }

        /* --- 用户预设功能 --- */
        let currentEditingPresetId = null;
        let presetToDelete = null;

                /* --- 用户预设界面逻辑 --- */
        function openUserPresetsInterface() {
            const el = document.getElementById('user-presets-interface');
            el.classList.add('active');
            // 强制显示
            el.style.display = 'flex';
            renderUserPresets();
        }

        function closeUserPresetsInterface() {
            const el = document.getElementById('user-presets-interface');
            el.classList.remove('active');
            // 核心修复：强制隐藏
            el.style.display = 'none';
        }

                        function renderUserPresets() {
            const container = document.getElementById('userPresetsContent');
            container.innerHTML = '';
            
            userPresets.forEach(preset => {
                // 1. 创建外层容器
                const wrapper = document.createElement('div');
                wrapper.className = 'swipe-item-wrapper preset-card-wrapper';
                
                // 2. 创建内容区域
                const contentBox = document.createElement('div');
                contentBox.className = 'swipe-content-box preset-card-content';
                
                const avatarSrc = (preset.avatar && preset.avatar.length > 5) ? preset.avatar : DEFAULT_AVATAR;
                
                contentBox.innerHTML = `
                    <img src="${avatarSrc}" class="preset-avatar-large">
                    <div class="preset-name-text">${preset.realName}</div>
                `;
                
                contentBox.onclick = function() { openEditPresetModal(preset); };

                // 3. 新增：在个人信息卡片显示按钮 (蓝色)
                const displayBtn = document.createElement('div');
                displayBtn.className = 'swipe-display-btn';
                displayBtn.innerText = '显示'; // 按钮文字简短一点，防止挤压
                displayBtn.onclick = function(e) {
                    e.stopPropagation();
                    setPresetAsMeCard(preset);
                };

                // 4. 删除按钮 (红色)
                const deleteBtn = document.createElement('div');
                deleteBtn.className = 'swipe-delete-btn';
                deleteBtn.innerText = '删除';
                deleteBtn.onclick = function(e) {
                    e.stopPropagation();
                    openDeletePresetConfirmWithName(preset);
                };

                wrapper.appendChild(contentBox);
                wrapper.appendChild(displayBtn); // 先加显示按钮
                wrapper.appendChild(deleteBtn);  // 再加删除按钮
                container.appendChild(wrapper);
            });
        }

        function openAddPresetModal() {
            currentEditingPresetId = null;
            document.getElementById('modalOverlay').classList.add('show');
            document.getElementById('modalUserPreset').classList.add('show');
            
            // 重置表单
            document.getElementById('presetAvatarPreview').src = DEFAULT_AVATAR;
            document.getElementById('inputPresetRealName').value = '';
            document.getElementById('inputPresetMiyoName').value = '';
            document.getElementById('inputPresetMiyoID').value = '';
            document.getElementById('inputPresetSign').value = '';
            document.getElementById('inputPresetPersona').value = '';
        }

        function openEditPresetModal(preset) {
            currentEditingPresetId = preset.id;
            document.getElementById('modalOverlay').classList.add('show');
            document.getElementById('modalUserPreset').classList.add('show');
            
            // 填充表单
            document.getElementById('presetAvatarPreview').src = preset.avatar || DEFAULT_AVATAR;
            document.getElementById('inputPresetRealName').value = preset.realName || '';
            document.getElementById('inputPresetMiyoName').value = preset.miyoName || '';
            document.getElementById('inputPresetMiyoID').value = preset.miyoID || '';
            document.getElementById('inputPresetSign').value = preset.sign || '';
            document.getElementById('inputPresetPersona').value = preset.persona || '';
        }

        function closeUserPresetModal() {
            document.getElementById('modalUserPreset').classList.remove('show');
            // 如果不在用户预设界面，则关闭遮罩，否则保留遮罩给底层界面使用（虽然这里是全屏界面，但也安全）
            // 实际上用户预设界面是全屏的，所以关闭弹窗不需要关闭 overlay，除非 overlay 是弹窗专属
            // 按照之前的逻辑，overlay 是共用的。
            // 这里因为用户预设界面在 miyo 设置之上，所以 overlay 应该只服务于弹窗。
            document.getElementById('modalOverlay').classList.remove('show');
        }

        async function saveUserPreset() {
            const avatar = document.getElementById('presetAvatarPreview').src;
            const realName = document.getElementById('inputPresetRealName').value;
            const miyoName = document.getElementById('inputPresetMiyoName').value;
            const miyoID = document.getElementById('inputPresetMiyoID').value;
            const sign = document.getElementById('inputPresetSign').value;
            const persona = document.getElementById('inputPresetPersona').value;

            if (!realName) {
                alert("请输入用户真名");
                return;
            }

            const presetData = {
                id: currentEditingPresetId || Date.now(),
                avatar: avatar,
                realName: realName,
                miyoName: miyoName,
                miyoID: miyoID,
                sign: sign,
                persona: persona
            };

            await saveDataToDB('user_presets', presetData);
            
            if (currentEditingPresetId) {
                const index = userPresets.findIndex(p => p.id === currentEditingPresetId);
                if (index !== -1) userPresets[index] = presetData;
            } else {
                userPresets.push(presetData);
            }

            renderUserPresets();
            closeUserPresetModal();
        }

        function openDeletePresetConfirm(preset) {
            presetToDelete = preset;
            document.getElementById('modalOverlay').classList.add('show');
            document.getElementById('modalDeletePresetConfirm').classList.add('show');
        }

        function closeDeletePresetConfirm() {
            document.getElementById('modalDeletePresetConfirm').classList.remove('show');
            if(!document.getElementById('modalSuccessCenter').classList.contains('show')) {
                document.getElementById('modalOverlay').classList.remove('show');
            }
            presetToDelete = null;
        }

        async function performDeletePreset() {
            if (!presetToDelete) return;
            await deleteDataFromDB('user_presets', presetToDelete.id);
            userPresets = userPresets.filter(p => p.id !== presetToDelete.id);
            renderUserPresets();
            closeDeletePresetConfirm();
            showSuccessModal();
        }

        /* --- 弹窗逻辑 --- */
        let currentEditingContext = null; 

        function openAddMenu() {
            document.getElementById('modalOverlay').classList.add('show');
            document.getElementById('modalMenu').classList.add('show');
        }

        function closeAllModals() {
            document.querySelectorAll('.bottom-modal').forEach(m => m.classList.remove('show'));
            document.getElementById('modalOverlay').classList.remove('show');
            setTimeout(() => { closeAvatarSettings(); }, 300);
        }

        function openRoleModal() {
            document.getElementById('modalMenu').classList.remove('show');
            setTimeout(() => {
                document.getElementById('modalAddRole').classList.add('show');
                // 修改：使用新默认头像
                document.getElementById('roleAvatarPreview').src = DEFAULT_AVATAR; 
                document.querySelectorAll('#modalAddRole input, #modalAddRole textarea').forEach(el => el.value = '');
            }, 300);
        }

        function closeRoleModal() {
            document.getElementById('modalAddRole').classList.remove('show');
            document.getElementById('modalOverlay').classList.remove('show');
        }

        function openGroupModal() {
            document.getElementById('modalMenu').classList.remove('show');
            updateGroupMemberSelect(); 
            setTimeout(() => {
                document.getElementById('modalAddGroup').classList.add('show');
                // 修改：使用新默认头像
                document.getElementById('groupAvatarPreview').src = DEFAULT_AVATAR; 
                document.getElementById('inputGroupName').value = '';
            }, 300);
        }

        function closeGroupModal() {
            document.getElementById('modalAddGroup').classList.remove('show');
            document.getElementById('modalOverlay').classList.remove('show');
        }

        async function saveNewRole() {
            const avatar = document.getElementById('roleAvatarPreview').src;
            const realName = document.getElementById('inputRoleRealName').value || "未命名";
            const remark = document.getElementById('inputRoleRemark').value;
            const persona = document.getElementById('inputRolePersona').value || "你是一个乐于助人的助手。";
            const sign = document.getElementById('inputRoleSign').value;
            const miyoName = document.getElementById('inputRoleMiyoName').value;
            const miyoID = document.getElementById('inputRoleID').value;

            const newRole = {
                name: remark || realName,
                realName: realName,
                miyoName: miyoName,
                miyoID: miyoID,
                sign: sign,
                avatar: avatar,
                persona: persona, 
                userSettings: {}, 
                chatHistory: [], 
                realTime: false,
                isPinned: false, 
                boundWorldBookIds: [], 
                id: Date.now()
            };
            await saveDataToDB('roles', newRole);
            addedRoles.push(newRole);
            renderFriendsList();
            if(!document.getElementById('content-friends').classList.contains('show')) toggleGroup('friends');
            closeRoleModal();
            switchTab(1); 
        }

        function updateGroupMemberSelect() {
            const container = document.getElementById('groupMemberSelect');
            container.innerHTML = '';
            if(addedRoles.length === 0) {
                container.innerHTML = '<div style="text-align:center;color:#999;font-size:12px;padding:10px;">暂无添加的角色</div>';
                return;
            }
            addedRoles.forEach(role => {
                const item = document.createElement('div');
                item.className = 'member-item';
                // 修改：使用新默认头像逻辑
                const avatarSrc = (role.avatar && role.avatar.length > 5 && role.avatar !== OLD_TRANSPARENT_AVATAR) ? role.avatar : DEFAULT_AVATAR;
                item.innerHTML = '<input type="checkbox" class="member-checkbox" value="' + role.id + '"><img src="' + avatarSrc + '" style="width:24px;height:24px;border-radius:4px;margin-right:8px;"><span style="font-size:14px;">' + role.name + '</span>';
                container.appendChild(item);
            });
        }

        async function saveNewGroup() {
            const avatar = document.getElementById('groupAvatarPreview').src;
            const groupName = document.getElementById('inputGroupName').value || "未命名群聊";
            const newGroup = { name: groupName, avatar: avatar, id: Date.now() };
            await saveDataToDB('groups', newGroup);
            addedGroups.push(newGroup);
            renderGroupsList();
            if(!document.getElementById('content-groups').classList.contains('show')) toggleGroup('groups');
            closeGroupModal();
            switchTab(1); 
        }

        function openAvatarSettings(context) {
            currentEditingContext = context; 
            let currentSrc;
            if (context === 'role') currentSrc = document.getElementById('roleAvatarPreview').src;
            else if (context === 'group') currentSrc = document.getElementById('groupAvatarPreview').src;
            else if (context === 'role_edit') currentSrc = document.getElementById('editRoleAvatarPreview').src;
            else if (context === 'user_edit') currentSrc = document.getElementById('editUserAvatarPreview').src;
            else if (context === 'preset') currentSrc = document.getElementById('presetAvatarPreview').src; // 新增预设头像

            document.getElementById('avatarSettingPreview').src = currentSrc;
            document.getElementById('inputAvatarUrl').value = '';
            document.getElementById('modalAvatarSettings').classList.add('show');
        }

        function closeAvatarSettings() {
            document.getElementById('modalAvatarSettings').classList.remove('show');
        }

        function previewUrlAvatar(url) {
            if(url.length > 5) document.getElementById('avatarSettingPreview').src = url;
        }

        function previewLocalAvatar(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) { document.getElementById('avatarSettingPreview').src = e.target.result; }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function saveAvatarChange() {
            const newSrc = document.getElementById('avatarSettingPreview').src;
            if(currentEditingContext === 'role') document.getElementById('roleAvatarPreview').src = newSrc;
            else if(currentEditingContext === 'group') document.getElementById('groupAvatarPreview').src = newSrc;
            else if(currentEditingContext === 'role_edit') document.getElementById('editRoleAvatarPreview').src = newSrc;
            else if(currentEditingContext === 'user_edit') document.getElementById('editUserAvatarPreview').src = newSrc;
            else if(currentEditingContext === 'preset') document.getElementById('presetAvatarPreview').src = newSrc; // 新增预设头像保存
            closeAvatarSettings();
        }

        /* --- 世界书逻辑 --- */
        let selectedWBGroupForAdd = null;
        let selectedWBGroupForBind = null;
        let selectedWBGroupForEdit = null; 
        let currentEditingBookId = null;
        let bookToDelete = null;
        let activeWBGroupIds = new Set(); 

        function openWorldBookInterface() {
            document.getElementById('worldbook-interface').classList.add('active');
            renderWorldBookMainList();
        }

        function closeWorldBookInterface() {
            document.getElementById('worldbook-interface').classList.remove('active');
        }

        function renderWorldBookMainList() {
            const container = document.getElementById('worldBookContent');
            container.innerHTML = '';
            
            addedWBGroups.forEach(group => {
                const booksInGroup = addedWBBooks.filter(b => b.groupId == group.id);
                if(booksInGroup.length > 0) {
                    const groupContainer = document.createElement('div');
                    groupContainer.className = 'wx-cell-group wb-cell-group'; 
                    groupContainer.style.marginTop = '10px';
                    
                    const header = document.createElement('div');
                    header.className = 'collapsible-header wb-group-header';
                    header.onclick = function() { toggleWBMainGroup(group.id); };
                    
                    const isExpanded = activeWBGroupIds.has(group.id);
                    const iconClass = isExpanded ? 'fas fa-chevron-right rotate-icon down' : 'fas fa-chevron-right rotate-icon';
                    
                    header.innerHTML = '<span>' + group.name + '</span><i class="' + iconClass + '" id="icon-wb-main-' + group.id + '"></i>';
                    groupContainer.appendChild(header);

                    const content = document.createElement('div');
                    content.className = isExpanded ? 'collapsible-content show' : 'collapsible-content';
                    content.id = 'content-wb-main-' + group.id;

                    booksInGroup.forEach(book => {
                        const wrapper = document.createElement('div');
                        wrapper.className = 'swipe-item-wrapper';
                        
                        const contentBox = document.createElement('div');
                        contentBox.className = 'swipe-content-box'; 
                        contentBox.innerHTML = '<div class="wx-cell-text" style="font-size:16px; color:#111;">' + book.name + '</div>';
                        contentBox.onclick = function() { openEditWorldBook(book); };

                        const deleteBtn = document.createElement('div');
                        deleteBtn.className = 'swipe-delete-btn';
                        deleteBtn.innerText = '删除';
                        deleteBtn.onclick = function(e) {
                            e.stopPropagation();
                            openDeleteWBConfirm(book);
                        };

                        wrapper.appendChild(contentBox);
                        wrapper.appendChild(deleteBtn);
                        content.appendChild(wrapper);
                    });
                    groupContainer.appendChild(content);
                    container.appendChild(groupContainer);
                }
            });
        }

        function toggleWBMainGroup(id) {
            const c = document.getElementById('content-wb-main-'+id), i = document.getElementById('icon-wb-main-'+id);
            if(c){ 
                if(c.classList.contains('show')){ 
                    c.classList.remove('show'); 
                    if(i)i.classList.remove('down');
                    activeWBGroupIds.delete(id); 
                } else { 
                    c.classList.add('show'); 
                    if(i)i.classList.add('down'); 
                    activeWBGroupIds.add(id); 
                } 
            }
        }

        // 分组设置
        function openGroupSettingsModal() {
            document.getElementById('modalOverlay').classList.add('show');
            document.getElementById('modalGroupSettings').classList.add('show');
            renderWBGroupListInModal();
            document.getElementById('inputWBGroupName').value = '';
        }

        function closeGroupSettingsModal() {
            document.getElementById('modalGroupSettings').classList.remove('show');
            if(!document.getElementById('worldbook-interface').classList.contains('active')) {
                 document.getElementById('modalOverlay').classList.remove('show');
            } else {
                 document.getElementById('modalOverlay').classList.remove('show');
            }
        }

                function renderWBGroupListInModal() {
            const list = document.getElementById('wbGroupList');
            list.innerHTML = '';
            
            addedWBGroups.forEach(g => {
                // 1. 创建滑动容器
                const wrapper = document.createElement('div');
                wrapper.className = 'swipe-item-wrapper';
                wrapper.style.borderBottom = '1px solid #eee'; // 保持原有分割线风格
                
                // 2. 创建内容区域
                const contentBox = document.createElement('div');
                contentBox.className = 'swipe-content-box';
                contentBox.style.padding = '12px'; // 调整内边距以匹配原样式
                contentBox.innerText = g.name;
                
                // 3. 创建删除按钮
                const deleteBtn = document.createElement('div');
                deleteBtn.className = 'swipe-delete-btn';
                deleteBtn.innerText = '删除';
                deleteBtn.onclick = function(e) {
                    e.stopPropagation();
                    openDeleteWBGroupConfirm(g); // 触发删除确认
                };

                wrapper.appendChild(contentBox);
                wrapper.appendChild(deleteBtn);
                list.appendChild(wrapper);
            });
        }

                async function addWBGroup() {
            const name = document.getElementById('inputWBGroupName').value.trim();
            if(!name) return;
            
            const newGroup = { id: Date.now(), name: name };
            
            // 1. 保存到数据库
            await saveDataToDB('wb_groups', newGroup);
            
            // 2. 更新内存数组
            addedWBGroups.push(newGroup);
            
            // 3. 刷新列表
            renderWBGroupListInModal();
            
            // 4. 清空输入框
            document.getElementById('inputWBGroupName').value = '';
        }

        async function saveWBGroups() {
            for(let g of addedWBGroups) {
                await saveDataToDB('wb_groups', g);
            }
            alert("分组已保存");
        }

        // 添加世界书
        function openAddWorldBookModal() {
            document.getElementById('modalOverlay').classList.add('show');
            document.getElementById('modalAddWorldBook').classList.add('show');
            document.getElementById('inputWBName').value = '';
            document.getElementById('inputWBContent').value = '';
            selectedWBGroupForAdd = null;
            document.getElementById('wbGroupSelectDisplay').querySelector('span').innerText = "请选择分组";
            document.getElementById('wbGroupSelectDisplay').classList.remove('selected');
            document.getElementById('wbGroupSelectOptions').classList.add('hidden');
            document.getElementById('icon-wb-group-select').classList.remove('down');
        }

        function closeAddWorldBookModal() {
            document.getElementById('modalAddWorldBook').classList.remove('show');
            document.getElementById('modalOverlay').classList.remove('show');
        }

        function toggleWBGroupSelect() {
            const opts = document.getElementById('wbGroupSelectOptions');
            const icon = document.getElementById('icon-wb-group-select');
            if(opts.classList.contains('hidden')) {
                opts.innerHTML = '';
                addedWBGroups.forEach(g => {
                    const item = document.createElement('div');
                    item.className = 'member-item';
                    item.style.padding = '10px';
                    item.innerText = g.name;
                    item.onclick = (e) => {
                        e.stopPropagation();
                        selectedWBGroupForAdd = g.id;
                        const display = document.getElementById('wbGroupSelectDisplay');
                        display.querySelector('span').innerText = g.name;
                        display.classList.add('selected');
                        opts.classList.add('hidden');
                        icon.classList.remove('down');
                    };
                    opts.appendChild(item);
                });
                opts.classList.remove('hidden');
                icon.classList.add('down');
            } else {
                opts.classList.add('hidden');
                icon.classList.remove('down');
            }
        }

        async function saveNewWorldBook() {
            const name = document.getElementById('inputWBName').value.trim();
            const content = document.getElementById('inputWBContent').value.trim();
            if(!name || !content || !selectedWBGroupForAdd) {
                document.getElementById('modalIncompleteInfo').classList.add('show');
                return;
            }
            const newBook = {
                id: Date.now(),
                name: name,
                groupId: selectedWBGroupForAdd,
                content: content
            };
            await saveDataToDB('wb_books', newBook);
            addedWBBooks.push(newBook);
            renderWorldBookMainList();
            closeAddWorldBookModal();
        }

        function closeIncompleteInfoModal() {
            document.getElementById('modalIncompleteInfo').classList.remove('show');
        }

        // 编辑世界书
        function openEditWorldBook(book) {
            currentEditingBookId = book.id;
            selectedWBGroupForEdit = book.groupId; 
            
            document.getElementById('modalOverlay').classList.add('show');
            document.getElementById('modalEditWorldBook').classList.add('show');
            document.getElementById('editWBName').value = book.name;
            document.getElementById('editWBContent').value = book.content;

            const group = addedWBGroups.find(g => g.id == book.groupId);
            const display = document.getElementById('editWBGroupSelectDisplay');
            if(group) {
                display.querySelector('span').innerText = group.name;
                display.classList.add('selected');
            } else {
                display.querySelector('span').innerText = "请选择分组";
                display.classList.remove('selected');
            }
            document.getElementById('editWBGroupSelectOptions').classList.add('hidden');
            document.getElementById('icon-edit-wb-group-select').classList.remove('down');
        }

        function closeEditWorldBookModal() {
            document.getElementById('modalEditWorldBook').classList.remove('show');
            document.getElementById('modalOverlay').classList.remove('show');
            currentEditingBookId = null;
        }

        function toggleEditWBGroupSelect() {
            const opts = document.getElementById('editWBGroupSelectOptions');
            const icon = document.getElementById('icon-edit-wb-group-select');
            if(opts.classList.contains('hidden')) {
                opts.innerHTML = '';
                addedWBGroups.forEach(g => {
                    const item = document.createElement('div');
                    item.className = 'member-item';
                    item.style.padding = '10px';
                    item.innerText = g.name;
                    item.onclick = (e) => {
                        e.stopPropagation();
                        selectedWBGroupForEdit = g.id;
                        const display = document.getElementById('editWBGroupSelectDisplay');
                        display.querySelector('span').innerText = g.name;
                        display.classList.add('selected');
                        opts.classList.add('hidden');
                        icon.classList.remove('down');
                    };
                    opts.appendChild(item);
                });
                opts.classList.remove('hidden');
                icon.classList.add('down');
            } else {
                opts.classList.add('hidden');
                icon.classList.remove('down');
            }
        }

        async function saveEditedWorldBook() {
            if(!currentEditingBookId) return;
            const name = document.getElementById('editWBName').value.trim();
            const content = document.getElementById('editWBContent').value.trim();
            
            if(!name || !content || !selectedWBGroupForEdit) {
                 document.getElementById('modalIncompleteInfo').classList.add('show'); 
                 return;
            }

            const bookIndex = addedWBBooks.findIndex(b => b.id === currentEditingBookId);
            if(bookIndex !== -1) {
                addedWBBooks[bookIndex].name = name;
                addedWBBooks[bookIndex].content = content;
                addedWBBooks[bookIndex].groupId = selectedWBGroupForEdit; 
                await saveDataToDB('wb_books', addedWBBooks[bookIndex]);
                renderWorldBookMainList();
                closeEditWorldBookModal();
            }
        }

        function openDeleteWBConfirm(book) {
            bookToDelete = book;
            document.getElementById('deleteWBConfirmText').innerText = '此操作会将“' + book.name + '”世界书删除，确定吗？';
            document.getElementById('modalOverlay').classList.add('show');
            document.getElementById('modalDeleteWBConfirm').classList.add('show');
        }

        function closeDeleteWBConfirm() {
            document.getElementById('modalDeleteWBConfirm').classList.remove('show');
            if(!document.getElementById('modalSuccessCenter').classList.contains('show')) {
                document.getElementById('modalOverlay').classList.remove('show');
            }
            bookToDelete = null;
        }

        async function performDeleteWB() {
            if(!bookToDelete) return;
            await deleteDataFromDB('wb_books', bookToDelete.id);
            addedWBBooks = addedWBBooks.filter(b => b.id !== bookToDelete.id);
            renderWorldBookMainList();
            closeDeleteWBConfirm();
            showSuccessModal();
        }

        let roleToDelete = null;
        let groupToDelete = null;

        function openDeleteRoleConfirm(role) {
            roleToDelete = role;
            document.getElementById('modalOverlay').classList.add('show');
            document.getElementById('modalDeleteRoleConfirm').classList.add('show');
        }

        function closeDeleteRoleConfirm() {
            document.getElementById('modalDeleteRoleConfirm').classList.remove('show');
            if(!document.getElementById('modalSuccessCenter').classList.contains('show')) {
                document.getElementById('modalOverlay').classList.remove('show');
            }
            roleToDelete = null;
        }

        async function performDeleteRole() {
            if(!roleToDelete) return;
            await deleteDataFromDB('roles', roleToDelete.id);
            addedRoles = addedRoles.filter(r => r.id !== roleToDelete.id);
            renderFriendsList();
            renderRecentChats();
            closeDeleteRoleConfirm();
            showSuccessModal();
        }

        function openDeleteGroupConfirm(group) {
            groupToDelete = group;
            document.getElementById('modalOverlay').classList.add('show');
            document.getElementById('modalDeleteGroupConfirm').classList.add('show');
        }

        function closeDeleteGroupConfirm() {
            document.getElementById('modalDeleteGroupConfirm').classList.remove('show');
            if(!document.getElementById('modalSuccessCenter').classList.contains('show')) {
                document.getElementById('modalOverlay').classList.remove('show');
            }
            groupToDelete = null;
        }

        async function performDeleteGroup() {
            if(!groupToDelete) return;
            await deleteDataFromDB('groups', groupToDelete.id);
            addedGroups = addedGroups.filter(g => g.id !== groupToDelete.id);
            renderGroupsList();
            closeDeleteGroupConfirm();
            showSuccessModal();
        }

        function openBindWorldBookModal() {
            document.getElementById('modalOverlay').classList.add('show');
            document.getElementById('modalBindWorldBook').classList.add('show');
            selectedWBGroupForBind = null;
            document.getElementById('bindGroupSelectDisplay').querySelector('span').innerText = "请选择分组";
            document.getElementById('bindGroupSelectDisplay').classList.remove('selected');
            document.getElementById('bindGroupSelectOptions').classList.add('hidden');
            document.getElementById('icon-bind-group-select').classList.remove('down');
            document.getElementById('bindBookList').innerHTML = '';
            renderBoundBooksDisplay();
        }

        function closeBindWorldBookModal() {
            document.getElementById('modalBindWorldBook').classList.remove('show');
            document.getElementById('modalOverlay').classList.remove('show');
        }

        function renderBoundBooksDisplay() {
            const container = document.getElementById('boundBooksDisplayArea');
            container.innerHTML = '';
            let ids = currentChatRole.boundWorldBookIds || [];
            if(currentChatRole.boundWorldBookId && !ids.includes(currentChatRole.boundWorldBookId)) {
                ids.push(currentChatRole.boundWorldBookId);
            }

            if(ids.length === 0) {
                container.innerHTML = '<span style="color:#999; font-size:14px;">暂无</span>';
                return;
            }

            ids.forEach(id => {
                const book = addedWBBooks.find(b => b.id == id);
                if(book) {
                    const tag = document.createElement('div');
                    tag.className = 'bound-book-tag';
                    tag.innerText = book.name;
                    container.appendChild(tag);
                }
            });
        }

        function toggleBindGroupSelect() {
            const opts = document.getElementById('bindGroupSelectOptions');
            const icon = document.getElementById('icon-bind-group-select');
            if(opts.classList.contains('hidden')) {
                opts.innerHTML = '';
                addedWBGroups.forEach(g => {
                    const item = document.createElement('div');
                    item.className = 'member-item';
                    item.style.padding = '10px';
                    item.innerText = g.name;
                    item.onclick = (e) => {
                        e.stopPropagation();
                        selectedWBGroupForBind = g.id;
                        const display = document.getElementById('bindGroupSelectDisplay');
                        display.querySelector('span').innerText = g.name;
                        display.classList.add('selected');
                        opts.classList.add('hidden');
                        icon.classList.remove('down');
                        renderBindBookList(g.id);
                    };
                    opts.appendChild(item);
                });
                opts.classList.remove('hidden');
                icon.classList.add('down');
            } else {
                opts.classList.add('hidden');
                icon.classList.remove('down');
            }
        }

        let selectedBookIdToBind = null;
        function renderBindBookList(groupId) {
            const list = document.getElementById('bindBookList');
            list.innerHTML = '';
            const books = addedWBBooks.filter(b => b.groupId == groupId);
            if(books.length === 0) {
                list.innerHTML = '<div style="text-align:center; color:#999; padding:10px;">该分组下无世界书</div>';
                return;
            }
            
            let currentBoundIds = currentChatRole.boundWorldBookIds || [];
            if(currentChatRole.boundWorldBookId && currentBoundIds.length === 0) {
                currentBoundIds.push(currentChatRole.boundWorldBookId);
            }

            books.forEach(b => {
                const item = document.createElement('div');
                item.className = 'member-item';
                const isChecked = currentBoundIds.includes(b.id) ? 'checked' : '';
                item.innerHTML = '<input type="checkbox" name="bindBookCheckbox" value="' + b.id + '" class="member-checkbox" ' + isChecked + '><span style="font-size:14px;">' + b.name + '</span>';
                list.appendChild(item);
            });
        }

        async function saveBindWorldBook() {
            if(!currentChatRole) return;
            
            const checkboxes = document.querySelectorAll('input[name="bindBookCheckbox"]:checked');
            const selectedIds = Array.from(checkboxes).map(cb => parseInt(cb.value));

            let currentBoundIds = currentChatRole.boundWorldBookIds || [];
            if(currentChatRole.boundWorldBookId && currentBoundIds.length === 0) {
                currentBoundIds.push(currentChatRole.boundWorldBookId);
            }

            if(selectedWBGroupForBind) {
                const booksInCurrentGroup = addedWBBooks.filter(b => b.groupId == selectedWBGroupForBind).map(b => b.id);
                currentBoundIds = currentBoundIds.filter(id => !booksInCurrentGroup.includes(id));
                selectedIds.forEach(id => {
                    if(!currentBoundIds.includes(id)) {
                        currentBoundIds.push(id);
                    }
                });
            }

            currentChatRole.boundWorldBookIds = currentBoundIds;
            delete currentChatRole.boundWorldBookId; 

            await saveDataToDB('roles', currentChatRole);
            const idx = addedRoles.findIndex(r => r.id === currentChatRole.id);
            if(idx !== -1) addedRoles[idx] = currentChatRole;
            
            alert("绑定成功");
            closeBindWorldBookModal();
        }

        /* --- 设置界面逻辑 --- */
                function openSettings() {
            const settings = document.getElementById('settings-interface');
            settings.classList.add('active');
            // 核心修改：强制设置 display 为 flex
            // 因为点击小白条时我们把它设为了 none，再次打开必须恢复
            settings.style.display = 'flex'; 
            
            updateStatusBar('dark'); 
            updateHomeBar('dark'); 
        }

                        function closeSettings() {
            const settings = document.getElementById('settings-interface');
            settings.classList.remove('active');
            settings.style.display = 'none';
            
            // 修改这里：同样使用新函数
            applyCurrentDesktopStyle(); 
        }

        function toggleApiSettings() {
            const body = document.getElementById('api-settings-body');
            const arrow = document.getElementById('icon-api-arrow');
            if (body.classList.contains('show')) {
                body.classList.remove('show');
                arrow.classList.remove('down');
            } else {
                body.classList.add('show');
                arrow.classList.add('down');
            }
        }

        function saveApiSettings() {
            const config = {
                url: document.getElementById('inputApiUrl').value.trim(),
                key: document.getElementById('inputApiKey').value.trim(),
                model: document.getElementById('inputModelName').value.trim()
            };
            localStorage.setItem('miyo_api_config', JSON.stringify(config));
            alert('配置已保存');
        }

        function loadApiSettings() {
            const saved = localStorage.getItem('miyo_api_config');
            if(saved) {
                const config = JSON.parse(saved);
                document.getElementById('inputApiUrl').value = config.url || '';
                document.getElementById('inputApiKey').value = config.key || '';
                document.getElementById('inputModelName').value = config.model || '';
            }
        }

        async function pullModels() {
            const url = document.getElementById('inputApiUrl').value.trim();
            const key = document.getElementById('inputApiKey').value.trim();
            if(!url || !key) {
                alert('请先填写API地址和密钥');
                return;
            }
            try {
                const baseUrl = url.endsWith('/') ? url.slice(0, -1) : url;
                const response = await fetch(baseUrl + '/v1/models', {
                    headers: { 'Authorization': 'Bearer ' + key }
                });
                const data = await response.json();
                
                if(data && data.data && data.data.length > 0) {
                    const select = document.getElementById('selectModelList');
                    select.innerHTML = '<option value="" disabled selected>选择模型...</option>';
                    data.data.forEach(m => {
                        const opt = document.createElement('option');
                        opt.value = m.id;
                        opt.text = m.id;
                        select.appendChild(opt);
                    });
                    alert('模型列表拉取成功，请点击输入框右侧箭头选择');
                } else {
                    alert('未找到模型数据');
                }
            } catch(e) {
                alert('拉取失败: ' + e.message);
            }
        }

        /* --- 聊天与API交互逻辑 --- */
        let currentChatRole = null; 
        let lastUserMessage = ""; 

                function openChatWindow(role) {
            currentChatRole = role; 
            localStorage.setItem('lastActiveRoleId', role.id);

            document.getElementById('chatTitle').innerText = role.name;
            const contentArea = document.getElementById('chatContent');
            contentArea.innerHTML = ''; 
            
            if(role.chatHistory && role.chatHistory.length > 0) {
                role.chatHistory.forEach(msg => {
                    const row = document.createElement('div');
                    row.className = 'chat-row ' + msg.role;
                    
                    // 获取角色头像
                    let avatar = (msg.role === 'role' && role.avatar && role.avatar.length > 5 && role.avatar !== OLD_TRANSPARENT_AVATAR) ? role.avatar : DEFAULT_AVATAR;
                    
                    // 获取用户头像
                    if(msg.role === 'user') {
                         if(role.userSettings && role.userSettings.avatar && role.userSettings.avatar.length > 5 && role.userSettings.avatar !== OLD_TRANSPARENT_AVATAR) {
                             avatar = role.userSettings.avatar;
                         } else {
                             avatar = DEFAULT_AVATAR;
                         }
                    }
                    
                    const date = new Date(msg.timestamp);
                    const timeStr = String(date.getHours()).padStart(2,'0') + ":" + String(date.getMinutes()).padStart(2,'0');
                    
                    const avatarHtml = '<div class="avatar-wrapper"><img src="' + avatar + '" class="chat-avatar"><div class="chat-time-label">' + timeStr + '</div></div>';
                    
                    if(msg.role === 'role') {
                        // 【修复核心】检测历史记录中的 isSticker 字段
                        let bubbleStyle = '';
                        if (msg.isSticker) {
                             // 如果是表情包，强制去背景、去边框、去阴影，并保持左边距以避开头像
                             bubbleStyle = 'style="background:transparent !important; padding:0 !important; border:none !important; box-shadow:none !important; margin-left: 50px;"';
                        }
                        row.innerHTML = avatarHtml + '<div class="chat-bubble" ' + bubbleStyle + '>' + msg.content + '</div>';
                    } else {
                        // 用户消息逻辑 (保持原有逻辑)
                        if (msg.isSticker) {
                            // 用户的表情包样式
                            row.innerHTML = `<div class="chat-bubble" style="background:transparent; padding:0; border:none;">${msg.content}</div>${avatarHtml}`;
                        } else {
                            // 用户的普通消息
                            row.innerHTML = '<div class="chat-bubble">' + msg.content + '</div>' + avatarHtml;
                        }
                    }
                    contentArea.appendChild(row);
                });
            }
            
            document.getElementById('chat-interface').classList.add('active');
            document.getElementById('chatInput').value = '';
            contentArea.scrollTop = contentArea.scrollHeight;
            checkInput();
        }

        function closeChatWindow() {
            document.getElementById('chat-interface').classList.remove('active');
            currentChatRole = null;
            localStorage.removeItem('lastActiveRoleId');
        }

        /* --- 修复：添加缺失的聊天更多功能 --- */
                function openChatMore() {
            if(!currentChatRole) return;
            document.getElementById('chat-more-interface').classList.add('active');
            
            // 填充角色信息
            const roleAvatar = (currentChatRole.avatar && currentChatRole.avatar.length > 5 && currentChatRole.avatar !== OLD_TRANSPARENT_AVATAR) ? currentChatRole.avatar : DEFAULT_AVATAR;
            document.getElementById('more-role-avatar-img').src = roleAvatar;
            document.getElementById('more-role-name-display').innerText = currentChatRole.name;
            document.getElementById('more-role-id-display').innerText = "Miyo号: " + (currentChatRole.miyoID || "未设置");

            // 填充角色编辑表单
            document.getElementById('editRoleAvatarPreview').src = roleAvatar;
            document.getElementById('editRoleRealName').value = currentChatRole.realName || "";
            document.getElementById('editRoleMiyoName').value = currentChatRole.miyoName || "";
            document.getElementById('editRoleRemark').value = currentChatRole.name || ""; 
            document.getElementById('editRoleMiyoID').value = currentChatRole.miyoID || "";
            document.getElementById('editRoleSign').value = currentChatRole.sign || "";
            document.getElementById('editRolePersona').value = currentChatRole.persona || "";

            // 填充用户设定表单
            const us = currentChatRole.userSettings || {};
            const userAvatar = (us.avatar && us.avatar.length > 5 && us.avatar !== OLD_TRANSPARENT_AVATAR) ? us.avatar : DEFAULT_AVATAR;
            document.getElementById('editUserAvatarPreview').src = userAvatar;
            document.getElementById('editUserRealName').value = us.realName || "";
            document.getElementById('editUserMiyoName').value = us.miyoName || "";
            document.getElementById('editUserMiyoID').value = us.miyoID || "";
            document.getElementById('editUserSign').value = us.sign || "";
            document.getElementById('editUserPersona').value = us.persona || "";

            // 填充实时开关状态
            document.getElementById('realTimeToggle').checked = currentChatRole.realTime || false;

            // 【新增】填充上下文记忆条数 (默认100)
            document.getElementById('inputContextLimit').value = currentChatRole.contextLimit || 100;
        }

        function closeChatMore() {
            document.getElementById('chat-more-interface').classList.remove('active');
        }

        async function saveMoreRoleSettings() {
            if(!currentChatRole) return;
            
            currentChatRole.avatar = document.getElementById('editRoleAvatarPreview').src;
            currentChatRole.realName = document.getElementById('editRoleRealName').value;
            currentChatRole.miyoName = document.getElementById('editRoleMiyoName').value;
            currentChatRole.name = document.getElementById('editRoleRemark').value || currentChatRole.realName;
            currentChatRole.miyoID = document.getElementById('editRoleMiyoID').value;
            currentChatRole.sign = document.getElementById('editRoleSign').value;
            currentChatRole.persona = document.getElementById('editRolePersona').value;

            await saveDataToDB('roles', currentChatRole);
            
            // 更新界面显示
            document.getElementById('more-role-avatar-img').src = currentChatRole.avatar;
            document.getElementById('more-role-name-display').innerText = currentChatRole.name;
            document.getElementById('more-role-id-display').innerText = "Miyo号: " + (currentChatRole.miyoID || "未设置");
            document.getElementById('chatTitle').innerText = currentChatRole.name;
            
            renderFriendsList();
            renderRecentChats();
            alert("角色设定已保存");
        }

        async function saveMoreUserSettings() {
            if(!currentChatRole) return;
            
            if(!currentChatRole.userSettings) currentChatRole.userSettings = {};
            
            currentChatRole.userSettings.avatar = document.getElementById('editUserAvatarPreview').src;
            currentChatRole.userSettings.realName = document.getElementById('editUserRealName').value;
            currentChatRole.userSettings.miyoName = document.getElementById('editUserMiyoName').value;
            currentChatRole.userSettings.miyoID = document.getElementById('editUserMiyoID').value;
            currentChatRole.userSettings.sign = document.getElementById('editUserSign').value;
            currentChatRole.userSettings.persona = document.getElementById('editUserPersona').value;

            await saveDataToDB('roles', currentChatRole);
            alert("用户设定已保存");
        }

        async function toggleRealTime() {
            if(!currentChatRole) return;
            currentChatRole.realTime = document.getElementById('realTimeToggle').checked;
            await saveDataToDB('roles', currentChatRole);
        }

        function showDeleteConfirm() {
            document.getElementById('modalOverlay').classList.add('show');
            document.getElementById('modalDeleteConfirm').classList.add('show');
        }

        function closeDeleteConfirm() {
            document.getElementById('modalDeleteConfirm').classList.remove('show');
            if(!document.getElementById('modalSuccessCenter').classList.contains('show')) {
                document.getElementById('modalOverlay').classList.remove('show');
            }
        }

        async function performDeleteHistory() {
            if(!currentChatRole) return;
            currentChatRole.chatHistory = [];
            await saveDataToDB('roles', currentChatRole);
            document.getElementById('chatContent').innerHTML = '';
            renderRecentChats();
            closeDeleteConfirm();
            showSuccessModal();
        }

        function showSuccessModal() {
            document.getElementById('modalOverlay').classList.add('show');
            document.getElementById('modalSuccessCenter').classList.add('show');
        }

                function closeSuccessModal() {
            document.getElementById('modalSuccessCenter').classList.remove('show');
            
            // 核心修复：检查当前是否还有其他的底部弹窗处于显示状态
            // 如果有（例如世界书分组还在显示），就不关闭遮罩层
            const openBottomModals = document.querySelectorAll('.bottom-modal.show');
            
            // 只有当没有底部弹窗显示时，才关闭遮罩层
            if (openBottomModals.length === 0) {
                document.getElementById('modalOverlay').classList.remove('show');
            }
        }

        function checkInput() {
            const inputVal = document.getElementById('chatInput').value.trim();
            const iconsGroup = document.getElementById('icons-group');
            const sendBtn = document.getElementById('btn-send');
            const replyIcon = document.getElementById('icon-reply');

            if(inputVal.length > 0) {
                iconsGroup.classList.add('hidden');
                sendBtn.classList.remove('hidden');
                replyIcon.classList.add('hidden');
            } else {
                iconsGroup.classList.remove('hidden');
                sendBtn.classList.add('hidden');
                replyIcon.classList.remove('hidden');
            }
        }

        async function sendUserMessage() {
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            if(!text) return;

            lastUserMessage = text; 
            
            const chatContent = document.getElementById('chatContent');
            const row = document.createElement('div');
            row.className = 'chat-row user';
            
            // 修改：使用新默认头像逻辑
            let userAvatarUrl = DEFAULT_AVATAR;
            if(currentChatRole && currentChatRole.userSettings && currentChatRole.userSettings.avatar && currentChatRole.userSettings.avatar.length > 5 && currentChatRole.userSettings.avatar !== OLD_TRANSPARENT_AVATAR) {
                userAvatarUrl = currentChatRole.userSettings.avatar;
            }
            
            const now = new Date();
            const timeStr = String(now.getHours()).padStart(2,'0') + ":" + String(now.getMinutes()).padStart(2,'0');
            const avatarHtml = '<div class="avatar-wrapper"><img src="' + userAvatarUrl + '" class="chat-avatar"><div class="chat-time-label">' + timeStr + '</div></div>';

            row.innerHTML = '<div class="chat-bubble">' + text + '</div>' + avatarHtml;
            chatContent.appendChild(row);
            chatContent.scrollTop = chatContent.scrollHeight;

            input.value = '';
            input.style.height = '36px';
            checkInput();

            if(!currentChatRole.chatHistory) currentChatRole.chatHistory = [];
            currentChatRole.chatHistory.push({
                role: 'user',
                content: text,
                timestamp: Date.now()
            });
            await saveDataToDB('roles', currentChatRole);
            renderRecentChats(); 
        }

        const sleep = ms => new Promise(r => setTimeout(r, ms));

                                                                async function receiveReply() {
            if (!currentChatRole) return;
            
            const saved = localStorage.getItem('miyo_api_config');
            if(!saved) {
                appendRoleMessage("请先在设置中配置API信息。", false); 
                return;
            }
            const config = JSON.parse(saved);
            if(!config.url || !config.key || !config.model) {
                appendRoleMessage("API配置不完整，请检查设置。", false);
                return;
            }

            const titleEl = document.getElementById('chatTitle');
            const originalTitle = currentChatRole.name;
            titleEl.innerText = "正在输入中…";

            // ----------------------------------------------------------------
            // 1. System Prompt - 核心修改：拟人化与去机械化指令
            // ----------------------------------------------------------------
            let basePersona = currentChatRole.persona || "你是一个普通的群友。";
            
            // 这里的 Prompt 是让 AI 变“活”的关键
            const systemSetting = `
[SCENE SETTING]
This is a REAL-TIME CHAT on a mobile app. 
You are strictly simulating a specific persona, NOT an AI assistant.

[HUMANIZATION PROTOCOL - CRITICAL]
1. **CASUAL VIBE**: Drop the formal grammar. It's okay to start with lowercase, omit periods, or use slang. Text like a real human.
2. **EMOTIONS**: Convey feelings through text style, NOT bracketed actions.
   - BAD: "I am angry (slams table)"
   - GOOD: "Are you kidding me?? Ugh." or "Whatever."
3. **SHORT RESPONSES**: Real people often send 1-word replies or just punctuation.
   - It is VALID to send just: "?" or "..." or "哈？" or a single emoji.
4. **MEMES/SLANG**: If your persona fits, use internet slang (e.g., 666, xswl, lol, bruh) or popular references.
5. **FORMATTING**:
   - Split your thoughts into MULTIPLE BUBBLES using '###'.
   - Keep each bubble SHORT (Max 1-2 sentences).
   - Example: 哈？###你认真的吗###...无语了
`;

            // 实时时间 (增加临场感)
            if (currentChatRole.realTime) {
                const now = new Date();
                basePersona += ` [Current Time: ${now.toLocaleString('zh-CN', { hour12: false })}]`;
            }

            // 用户设定
            if(currentChatRole.userSettings) {
                 const us = currentChatRole.userSettings;
                 basePersona += ` [Talking to: ${us.realName || 'Unknown'} (Nickname: ${us.miyoName || 'User'})]`;
            }

            // 世界书
            const boundIds = currentChatRole.boundWorldBookIds || [];
            if(currentChatRole.boundWorldBookId && boundIds.length === 0) boundIds.push(currentChatRole.boundWorldBookId);
            if(boundIds.length > 0) {
                const books = addedWBBooks.filter(b => boundIds.includes(b.id));
                books.forEach(b => basePersona += ` [Backstory/Lore: ${b.content}]`);
            }

            // 表情包
            let stickerInstruction = "";
            if (savedStickers && savedStickers.length > 0) {
                // 只是简单列出ID，让AI自己根据情绪选择
                const sList = savedStickers.map(s => `ID:${s.id},Desc:"${s.desc}"`).join(';');
                stickerInstruction = `\n[STICKER SYSTEM]\nAvailable IDs:[${sList}]\nTo send a sticker, output ALONE: :::STICKER:::ID:::`;
            }
            
            // ----------------------------------------------------------------
            // 2. Chat History
            // ----------------------------------------------------------------
            let contextMessages = [];
            if (currentChatRole.chatHistory && currentChatRole.chatHistory.length > 0) {
                const limit = currentChatRole.contextLimit || 100;
                contextMessages = currentChatRole.chatHistory.slice(-limit).map(h => ({
                    role: h.role === 'role' ? 'assistant' : 'user',
                    content: h.isSticker ? `[Sent Sticker]` : h.content
                }));
            }

            const messages = [
                { role: "system", content: basePersona + systemSetting + stickerInstruction },
                ...contextMessages
            ];

            try {
                const baseUrl = config.url.endsWith('/') ? config.url.slice(0, -1) : config.url;
                const response = await fetch(baseUrl + '/v1/chat/completions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + config.key },
                    body: JSON.stringify({ model: config.model, messages: messages, stream: false })
                });
                
                if(!response.ok) throw new Error("API Error: " + response.status);
                const data = await response.json();
                let replyContent = (data.choices && data.choices[0]) ? data.choices[0].message.content : "";
                
                // ----------------------------------------------------------------
                // 3. 处理逻辑 (保持之前的极简逻辑)
                // ----------------------------------------------------------------
                let rawParts = replyContent.split('###');
                let finalParts = [];

                rawParts.forEach(part => {
                    let trimmed = part.trim();
                    if (!trimmed) return;

                    const stickerSegments = trimmed.split(/(:::STICKER:::\d+:::)/g);
                    
                    stickerSegments.forEach(seg => {
                        let segText = seg.trim();
                        if (!segText) return;

                        if (segText.match(/^:::STICKER:::(\d+):::$/)) {
                            finalParts.push({ type: 'sticker', content: segText });
                        } else {
                            finalParts.push({ type: 'text', content: segText });
                        }
                    });
                });
                
                // ----------------------------------------------------------------
                // 4. 渲染消息
                // ----------------------------------------------------------------
                if(finalParts.length > 0) {
                    for(const part of finalParts) {
                        if (part.type === 'sticker') {
                            const match = part.content.match(/^:::STICKER:::(\d+):::$/);
                            if (match) {
                                const s = savedStickers.find(st => st.id === parseInt(match[1]));
                                if (s) {
                                    await appendRoleMessage(`<img src="${s.url}" style="max-width:120px; border-radius:8px;" data-sticker-desc="${s.desc}">`, true, true); 
                                }
                            }
                        } else {
                            await appendRoleMessage(part.content, true, false);
                        }
                        // 随机延迟让回复更有节奏感
                        let delay = 800 + Math.random() * 1200;
                        await sleep(delay); 
                    }
                } else {
                    appendRoleMessage("...", true, false);
                }

            } catch (e) {
                appendRoleMessage("请求失败: " + e.message, false);
            } finally {
                titleEl.innerText = originalTitle;
            }
        }

                        async function appendRoleMessage(text, saveToDB = true, isSticker = false) {
            const chatContent = document.getElementById('chatContent');
            const row = document.createElement('div');
            row.className = 'chat-row role';
            
            const now = new Date();
            const timeStr = String(now.getHours()).padStart(2,'0') + ":" + String(now.getMinutes()).padStart(2,'0');
            
            const avatarSrc = (currentChatRole.avatar && currentChatRole.avatar.length > 5 && currentChatRole.avatar !== OLD_TRANSPARENT_AVATAR) ? currentChatRole.avatar : DEFAULT_AVATAR;
            const avatarHtml = '<div class="avatar-wrapper"><img src="' + avatarSrc + '" class="chat-avatar"><div class="chat-time-label">' + timeStr + '</div></div>';

            // 【核心修改】如果是表情包，强制清除背景、边框、阴影、内边距
            let bubbleStyle = isSticker 
                ? 'style="background:transparent !important; padding:0 !important; border:none !important; box-shadow:none !important; margin-left: 50px;"' 
                : '';
            
            row.innerHTML = avatarHtml + '<div class="chat-bubble" ' + bubbleStyle + '>' + text + '</div>';
            chatContent.appendChild(row);
            chatContent.scrollTop = chatContent.scrollHeight;

            if (saveToDB) {
                if(!currentChatRole.chatHistory) currentChatRole.chatHistory = [];
                currentChatRole.chatHistory.push({
                    role: 'role',
                    content: text,
                    isSticker: isSticker,
                    timestamp: Date.now()
                });
                await saveDataToDB('roles', currentChatRole);
                renderRecentChats(); 
            }
        }

        /* --- 桌面滑动逻辑 --- */
        const slider = document.getElementById('desktopSlider');
        const touchArea = document.querySelector('.ui-container');
        let startX = 0; let isDragging = false; let startTranslate = 0;

        touchArea.addEventListener('touchstart', (e) => {
            if (document.getElementById('wechat-app').style.display === 'flex') return;
            startX = e.touches[0].clientX; isDragging = true; slider.style.transition = 'none'; startTranslate = currentDesktop * -50; 
            bgLayer2.style.transition = 'none';
        });
        touchArea.addEventListener('touchmove', (e) => {
            if (!isDragging) return; if (document.getElementById('wechat-app').style.display === 'flex') return;
            const diff = e.touches[0].clientX - startX;
            let nextTranslate = startTranslate + (diff / touchArea.clientWidth) * 50;
            if (nextTranslate > 0) nextTranslate *= 0.3; if (nextTranslate < -50) nextTranslate = -50 + (nextTranslate + 50) * 0.3;
            slider.style.transform = `translateX(${nextTranslate}%)`;
            let opacity = Math.abs(nextTranslate) / 50;
            bgLayer2.style.opacity = Math.min(Math.max(opacity, 0), 1);
        });
        touchArea.addEventListener('touchend', (e) => {
            if (!isDragging) return; isDragging = false;
            slider.style.transition = 'transform 0.4s cubic-bezier(0.25, 1, 0.5, 1)';
            bgLayer2.style.transition = 'opacity 0.4s cubic-bezier(0.25, 1, 0.5, 1)';
            const diff = e.changedTouches[0].clientX - startX;
            if (Math.abs(diff) > 50) { if (diff < 0 && currentDesktop === 0) currentDesktop = 1; else if (diff > 0 && currentDesktop === 1) currentDesktop = 0; }
            slider.style.transform = `translateX(${currentDesktop * -50}%)`;
            bgLayer2.style.opacity = currentDesktop === 0 ? 0 : 1;
            document.querySelectorAll('.pagination .dot').forEach((d, i) => d.classList.toggle('active', i === currentDesktop));
            applyCurrentDesktopStyle(); 
        });

        /* --- 桌面美化功能逻辑 --- */

        function toggleDesktopSettings() {
            const body = document.getElementById('desktop-settings-body');
            const arrow = document.getElementById('icon-desktop-arrow');
            if (body.classList.contains('show')) {
                body.classList.remove('show');
                arrow.classList.remove('down');
            } else {
                body.classList.add('show');
                arrow.classList.add('down');
            }
        }

        function handleWallpaperFile(input, pageIndex) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    setWallpaper(pageIndex, e.target.result);
                }
                reader.readAsDataURL(input.files[0]);
            }
            input.value = ''; // 重置 input 以便重复选择同一文件
        }

        function triggerUrlUpload(pageIndex) {
            const url = prompt("请输入图片 URL 链接:");
            if (url && url.trim().length > 0) {
                setWallpaper(pageIndex, url.trim());
            }
        }

                function setWallpaper(pageIndex, src) {
            // 1. 更新变量
            if (pageIndex === 1) page1Url = src;
            else page2Url = src;

            // 2. 更新背景图显示
            const layer = pageIndex === 1 ? bgLayer1 : bgLayer2;
            layer.style.backgroundImage = src ? `url('${src}')` : 'none'; // 修复：空值处理

            // 3. 更新预览图
            const preview = document.getElementById(`preview-wp-${pageIndex}`);
            if (src) {
                preview.src = src;
                preview.classList.add('show');
            } else {
                preview.classList.remove('show');
            }

            // 4. 保存配置
            saveDesktopSettings();

            // 5. 新增：计算该页面的颜色模式 (pageIndex - 1 因为数组是 0 和 1)
            calculatePageColorMode(src, pageIndex - 1);
        }

                                        function updateStatusBarPosition(offset) {
            // 转换为整数
            const val = parseInt(offset);
            
            // 1. 移动状态栏和灵动岛
            const statusBar = document.getElementById('statusBar');
            const island = document.querySelector('.dynamic-island');
            
            statusBar.style.transform = `translateY(${val}px)`;
            island.style.transform = `translate(-50%, ${val}px)`;

            // 2. 更新全局 CSS 变量
            document.documentElement.style.setProperty('--status-bar-offset', val + 'px');

            // 3. 桌面1 (widget-area) 处理: 基础 padding-top 为 100px
            const widgetAreas = document.querySelectorAll('.widget-area');
            widgetAreas.forEach(area => {
                area.style.paddingTop = (100 + val) + 'px';
            });

            // 4. 新增：桌面2 (widget-board) 处理: 基础 padding-top 为 60px
            const widgetBoards = document.querySelectorAll('.widget-board');
            widgetBoards.forEach(board => {
                board.style.paddingTop = (60 + val) + 'px';
            });

            // 保存设置
            localStorage.setItem('miyo_statusbar_offset', val);
        }

        function resetWallpaper(pageIndex) {
            // 将 URL 设为空字符串，即恢复默认白色
            setWallpaper(pageIndex, '');
            // 隐藏预览图
            const preview = document.getElementById(`preview-wp-${pageIndex}`);
            preview.classList.remove('show');
            preview.src = '';
        }

        function saveDesktopSettings() {
            const settings = {
                wp1: page1Url,
                wp2: page2Url
            };
            localStorage.setItem('miyo_desktop_settings', JSON.stringify(settings));
        }

                // 修改 loadDesktopSettings 函数，确保加载时正确应用 "无壁纸=黑字" 的逻辑
                function loadDesktopSettings() {
            // 1. 加载壁纸
            const savedWp = localStorage.getItem('miyo_desktop_settings');
            if (savedWp) {
                const settings = JSON.parse(savedWp);
                setWallpaper(1, settings.wp1 || ''); 
                setWallpaper(2, settings.wp2 || '');
            } else {
                setWallpaper(1, '');
                setWallpaper(2, '');
            }

            // 2. 加载状态栏位置
            const savedOffset = localStorage.getItem('miyo_statusbar_offset');
            if (savedOffset !== null) {
                document.getElementById('statusBarSlider').value = savedOffset;
                updateStatusBarPosition(savedOffset);
            }

            // 3. 加载状态栏开关 (默认为 true)
            const savedVisible = localStorage.getItem('miyo_statusbar_visible');
            const isVisible = savedVisible === null ? true : (savedVisible === 'true');
            document.getElementById('statusBarToggle').checked = isVisible;
            toggleStatusBarVisibility(); // 应用状态
        }

        /* --- 选择用户预设功能逻辑 --- */
        let selectedPresetIdForChat = null; // 当前选中的预设ID

        function openSelectUserPresetModal() {
            document.getElementById('modalOverlay').classList.add('show');
            document.getElementById('modalSelectUserPreset').classList.add('show');
            selectedPresetIdForChat = null; // 重置选择
            renderSelectUserPresetList();
        }

        function closeSelectUserPresetModal() {
            document.getElementById('modalSelectUserPreset').classList.remove('show');
            // 注意：这里不关闭 Overlay，因为下面还有 chat-more 界面或者 setting 界面
            // 只有当所有弹窗都关闭时才关 Overlay，但为了保险，这里保持 Overlay 显示
            // 因为这个弹窗是从"更多"界面点出来的，"更多"界面本身不是弹窗而是全屏层，所以 Overlay 是给弹窗用的
            // 如果只打开了这个弹窗，关闭它应该关闭 Overlay。
            // 简单处理：如果还有其他 modal open，就不关 overlay。这里直接关掉 overlay 可能会导致底层穿透
            // 既然 chat-more 是全屏层 (z-index 350)，modal 是 (z-index 600)，overlay 是 (z-index 500)
            // 关闭这个弹窗应该去掉 overlay
            document.getElementById('modalOverlay').classList.remove('show');
        }

                /* --- 修复版：选择用户预设逻辑 --- */
        
        // 1. 替换渲染函数：使用 JS 绑定事件，解决点击无效问题
        function renderSelectUserPresetList() {
            const container = document.getElementById('selectUserPresetListContainer');
            container.innerHTML = '';

            if (userPresets.length === 0) {
                container.innerHTML = '<div style="text-align:center; color:#999; padding:20px;">暂无预设，请先去Miyo设置中添加</div>';
                return;
            }

            userPresets.forEach(preset => {
                const item = document.createElement('div');
                // 确保 ID 类型匹配（防止一个是字符串一个是数字）
                const isSelected = (selectedPresetIdForChat == preset.id);
                item.className = `preset-select-item ${isSelected ? 'active' : ''}`;
                
                const avatarSrc = (preset.avatar && preset.avatar.length > 5) ? preset.avatar : DEFAULT_AVATAR;

                // 构建 HTML 结构 (注意：这里去掉了 onclick 属性)
                item.innerHTML = `
                    <div class="preset-select-header">
                        <div class="preset-select-info">
                            <img src="${avatarSrc}" style="width:40px; height:40px; border-radius:8px; margin-right:12px; object-fit:cover;">
                            <div style="font-weight:600; font-size:15px;">${preset.realName}</div>
                        </div>
                        <div class="preset-select-checkbox ${isSelected ? 'checked' : ''}"></div>
                    </div>
                    <div class="preset-preview-details" id="preset-details-${preset.id}">
                        <div><strong>Miyo名:</strong> ${preset.miyoName || '-'}</div>
                        <div><strong>Miyo号:</strong> ${preset.miyoID || '-'}</div>
                        <div><strong>签名:</strong> ${preset.sign || '-'}</div>
                        <div style="margin-top:4px;"><strong>人设:</strong> <span style="color:#888;">${(preset.persona || '').substring(0, 50)}...</span></div>
                    </div>
                `;

                // --- 核心修复：使用 JS 直接绑定点击事件 ---
                
                // 1. 绑定头部点击 -> 展开/折叠详情
                const header = item.querySelector('.preset-select-header');
                header.onclick = function() { 
                    togglePresetPreviewDetails(preset.id); 
                };

                // 2. 绑定复选框点击 -> 选中/取消 (并阻止冒泡)
                const checkbox = item.querySelector('.preset-select-checkbox');
                checkbox.onclick = function(e) {
                    e.stopPropagation(); // 关键：阻止事件传给 header，防止触发展开
                    selectPresetItem(preset.id); // 调用选择逻辑
                };

                container.appendChild(item);
            });
        }

        function togglePresetPreviewDetails(id) {
            const details = document.getElementById(`preset-details-${id}`);
            if (details.classList.contains('show')) {
                details.classList.remove('show');
            } else {
                // 仅展开当前，关闭其他？这里选择允许同时展开
                details.classList.add('show');
            }
        }

        
        // 2. 替换选择函数：简化逻辑
        function selectPresetItem(id) {
            // 切换选中状态
            if (selectedPresetIdForChat == id) {
                selectedPresetIdForChat = null; // 取消
            } else {
                selectedPresetIdForChat = id; // 选中
            }
            // 重新渲染列表以更新 UI (打钩状态)
            renderSelectUserPresetList();
        }

        function confirmSelectUserPreset() {
            if (!selectedPresetIdForChat) {
                alert("请先选择一个预设");
                return;
            }

            const preset = userPresets.find(p => p.id === selectedPresetIdForChat);
            if (preset) {
                // 填充到"修改用户设定"的表单中
                document.getElementById('editUserAvatarPreview').src = preset.avatar || DEFAULT_AVATAR;
                document.getElementById('editUserRealName').value = preset.realName || "";
                document.getElementById('editUserMiyoName').value = preset.miyoName || "";
                document.getElementById('editUserMiyoID').value = preset.miyoID || "";
                document.getElementById('editUserSign').value = preset.sign || "";
                document.getElementById('editUserPersona').value = preset.persona || "";
                
                closeSelectUserPresetModal();
            }
        }

        function toggleStatusBarVisibility() {
            const isChecked = document.getElementById('statusBarToggle').checked;
            const statusBar = document.getElementById('statusBar');
            const dynamicIsland = document.querySelector('.dynamic-island');
            const slider = document.getElementById('statusBarSlider');

            if (isChecked) {
                statusBar.style.display = 'flex';
                dynamicIsland.style.display = 'block';
                slider.disabled = false;
                slider.parentElement.style.opacity = '1';
            } else {
                statusBar.style.display = 'none';
                dynamicIsland.style.display = 'none';
                slider.disabled = true;
                slider.parentElement.style.opacity = '0.5';
            }
            
            // 保存开关状态
            localStorage.setItem('miyo_statusbar_visible', isChecked);
        }

        /* --- 用户预设：左滑功能逻辑 --- */
        let presetToDeleteWithName = null;

        // 1. 设置为个人信息卡片
        function setPresetAsMeCard(preset) {
            // 更新 HTML 中的个人卡片
            const avatarSrc = (preset.avatar && preset.avatar.length > 5) ? preset.avatar : DEFAULT_AVATAR;
            
            const card = document.getElementById('me-header-card');
            card.querySelector('.me-avatar').src = avatarSrc;
            card.querySelector('.me-nickname').innerText = preset.miyoName || preset.realName || "User";
            card.querySelector('.me-wxid').innerText = "Miyo号: " + (preset.miyoID || "未设置");

            // 保存到本地存储 (持久化)
            const meSettings = {
                avatar: avatarSrc,
                nickname: preset.miyoName || preset.realName,
                wxid: preset.miyoID
            };
            localStorage.setItem('miyo_me_card_settings', JSON.stringify(meSettings));

            // 显示成功弹窗
            document.getElementById('modalOverlay').classList.add('show');
            document.getElementById('modalSetDisplaySuccess').classList.add('show');
        }

        function closeSetDisplaySuccessModal() {
            document.getElementById('modalSetDisplaySuccess').classList.remove('show');
            // 如果没有其他弹窗，关闭遮罩
            if (!document.getElementById('modalDeletePresetConfirmWithName').classList.contains('show')) {
                document.getElementById('modalOverlay').classList.remove('show');
            }
        }

        // 2. 删除预设 (带名字确认)
        function openDeletePresetConfirmWithName(preset) {
            presetToDeleteWithName = preset;
            const text = document.getElementById('deletePresetConfirmText');
            text.innerText = `此操作会完全删除“${preset.realName}”该预设，确定吗？`;
            
            document.getElementById('modalOverlay').classList.add('show');
            document.getElementById('modalDeletePresetConfirmWithName').classList.add('show');
        }

        function closeDeletePresetConfirmWithName() {
            document.getElementById('modalDeletePresetConfirmWithName').classList.remove('show');
            document.getElementById('modalOverlay').classList.remove('show');
            presetToDeleteWithName = null;
        }

        async function performDeletePresetWithName() {
            if (!presetToDeleteWithName) return;
            
            await deleteDataFromDB('user_presets', presetToDeleteWithName.id);
            userPresets = userPresets.filter(p => p.id !== presetToDeleteWithName.id);
            renderUserPresets();
            
            closeDeletePresetConfirmWithName();
            showSuccessModal(); // 复用已有的“删除成功”弹窗
        }

        // 3. 初始化加载个人卡片 (需要在 window.onload 中调用)
        function loadMeCardSettings() {
            const saved = localStorage.getItem('miyo_me_card_settings');
            if (saved) {
                const settings = JSON.parse(saved);
                const card = document.getElementById('me-header-card');
                if (settings.avatar) card.querySelector('.me-avatar').src = settings.avatar;
                if (settings.nickname) card.querySelector('.me-nickname').innerText = settings.nickname;
                if (settings.wxid) card.querySelector('.me-wxid').innerText = "Miyo号: " + settings.wxid;
            }
        }
        /* --- 世界书分组删除逻辑 --- */
        let wbGroupToDelete = null;

        function openDeleteWBGroupConfirm(group) {
            wbGroupToDelete = group;
            const text = document.getElementById('deleteWBGroupConfirmText');
            text.innerText = `此操作会删除“${group.name}”该世界书分组，确定吗？`;
            
            // 注意：这里不操作 overlay，因为下面已经有一个弹窗打开着了，overlay 应该是显示的
            // 我们直接显示这个高层级的弹窗
            document.getElementById('modalDeleteWBGroupConfirm').classList.add('show');
        }

        function closeDeleteWBGroupConfirm() {
            document.getElementById('modalDeleteWBGroupConfirm').classList.remove('show');
            wbGroupToDelete = null;
        }

        async function performDeleteWBGroup() {
            if (!wbGroupToDelete) return;
            
            // 1. 从数据库删除
            await deleteDataFromDB('wb_groups', wbGroupToDelete.id);
            
            // 2. 更新内存数组
            addedWBGroups = addedWBGroups.filter(g => g.id !== wbGroupToDelete.id);
            
            // 3. 刷新列表
            renderWBGroupListInModal();
            
            // 4. 关闭确认弹窗
            closeDeleteWBGroupConfirm();
            
            // 5. 显示成功弹窗 (复用现有的)
            showSuccessModal(); 
        }
        /* --- 输入框自动高度逻辑 --- */
        function autoResizeInput(element) {
            // 先重置高度，以便计算 scrollHeight (处理删除文字的情况)
            element.style.height = '36px'; 
            
            // 如果内容高度超过了基础高度，则撑开
            if (element.scrollHeight > 36) {
                element.style.height = element.scrollHeight + 'px';
            }
        }
        /* --- 表情包功能逻辑 --- */
        let isStickerDeleteMode = false;
        let selectedStickersToDelete = new Set();
        let tempLocalStickerBase64 = "";

        // 1. 打开/关闭主弹窗
        function openStickerModal() {
            document.getElementById('modalOverlay').classList.add('show');
            document.getElementById('modalStickers').classList.add('show');
            // 每次打开重置为正常模式
            isStickerDeleteMode = false;
            selectedStickersToDelete.clear();
            updateStickerModalUI();
            renderStickerGrid();
        }

        function closeStickerModal() {
            document.getElementById('modalStickers').classList.remove('show');
            // 如果没有其他弹窗，关闭遮罩
            if(!document.getElementById('chat-more-interface').classList.contains('active')) {
                 // 这里需要判断逻辑，简单起见，如果是在聊天界面打开的，关闭时去掉遮罩
                 document.getElementById('modalOverlay').classList.remove('show');
            }
        }

        function updateStickerModalUI() {
            const closeBtn = document.getElementById('btn-close-sticker-modal');
            const footer = document.getElementById('stickerDeleteFooter');
            
            if (isStickerDeleteMode) {
                closeBtn.style.display = 'none';
                footer.style.display = 'flex';
            } else {
                closeBtn.style.display = 'block';
                footer.style.display = 'none';
            }
        }

        function renderStickerGrid() {
            const container = document.getElementById('stickerGridContent');
            container.innerHTML = '';
            
            const grid = document.createElement('div');
            grid.className = 'sticker-grid';

            savedStickers.forEach(sticker => {
                const item = document.createElement('div');
                item.className = 'sticker-item';
                if (isStickerDeleteMode && selectedStickersToDelete.has(sticker.id)) {
                    item.classList.add('selected');
                }

                item.innerHTML = `
                    <img src="${sticker.url}" class="sticker-img">
                    <div class="sticker-desc">${sticker.desc || ''}</div>
                    <div class="sticker-delete-overlay">
                        <div class="sticker-check-icon"></div>
                    </div>
                `;

                                // 修改这里：传入 sticker.desc
                item.onclick = () => handleStickerClick(sticker.id, sticker.url, sticker.desc);
                grid.appendChild(item);
            });

            container.appendChild(grid);
        }

        function handleStickerClick(id, url, desc) {
            if (isStickerDeleteMode) {
                // 删除模式：选中/取消
                if (selectedStickersToDelete.has(id)) {
                    selectedStickersToDelete.delete(id);
                } else {
                    selectedStickersToDelete.add(id);
                }
                renderStickerGrid();
            } else {
                // 传入 url 和 desc
                sendStickerMessage(url, desc);
                closeStickerModal();
            }
        }

                                function sendStickerMessage(url, desc) {
    // 1. 修正 imgTag 的插值
    const imgTag = `<img src="${url}" style="max-width:120px; border-radius:8px;" data-sticker-desc="${desc || '表情包'}">`;
    
    if(!currentChatRole) return;
    
    const chatContent = document.getElementById('chatContent');
    const row = document.createElement('div');
    row.className = 'chat-row user';
    
    let userAvatarUrl = DEFAULT_AVATAR;
    if(currentChatRole.userSettings && currentChatRole.userSettings.avatar) {
        userAvatarUrl = currentChatRole.userSettings.avatar;
    }
    
    const now = new Date();
    const timeStr = String(now.getHours()).padStart(2,'0') + ":" + String(now.getMinutes()).padStart(2,'0');
    
    // 2. 修正 avatarHtml 的插值
    const avatarHtml = `<div class="avatar-wrapper"><img src="${userAvatarUrl}" class="chat-avatar"><div class="chat-time-label">${timeStr}</div></div>`;

    // 3. 修正 row.innerHTML 的插值
    row.innerHTML = `<div class="chat-bubble" style="background:transparent; padding:0; border:none;">${imgTag}</div>${avatarHtml}`;
    
    chatContent.appendChild(row);
    chatContent.scrollTop = chatContent.scrollHeight;

    if(!currentChatRole.chatHistory) currentChatRole.chatHistory = [];
    currentChatRole.chatHistory.push({
        role: 'user',
        content: imgTag,
        isSticker: true,
        desc: desc || '表情包',
        timestamp: Date.now()
    });
    saveDataToDB('roles', currentChatRole);
    renderRecentChats();
}

        // 2. 导入类型弹窗
        function openStickerImportTypeModal() {
            document.getElementById('modalStickerImportType').classList.add('show');
        }
        function closeStickerImportTypeModal() {
            document.getElementById('modalStickerImportType').classList.remove('show');
        }

        // 3. 单个导入
        function openSingleImportModal() {
            document.getElementById('modalStickerSingleImport').classList.add('show');
            document.getElementById('inputStickerUrl').value = '';
            document.getElementById('inputStickerDesc').value = '';
            document.getElementById('stickerUrlPreview').src = '';
        }
        function closeSingleImportModal() {
            document.getElementById('modalStickerSingleImport').classList.remove('show');
        }
        function previewStickerUrl(url) {
            document.getElementById('stickerUrlPreview').src = url;
        }
        async function saveSingleSticker() {
            const url = document.getElementById('inputStickerUrl').value;
            const desc = document.getElementById('inputStickerDesc').value;
            if(!url) return;
            
            const sticker = { id: Date.now(), url: url, desc: desc };
            await saveDataToDB('stickers', sticker);
            savedStickers.push(sticker);
            
            closeSingleImportModal();
            closeStickerImportTypeModal();
            renderStickerGrid();
        }

        // 4. 批量导入
        function openBatchImportModal() {
            document.getElementById('modalStickerBatchImport').classList.add('show');
            document.getElementById('inputStickerBatch').value = '';
        }
        function closeBatchImportModal() {
            document.getElementById('modalStickerBatchImport').classList.remove('show');
        }
        async function saveBatchStickers() {
            const text = document.getElementById('inputStickerBatch').value;
            const lines = text.split('\n');
            let count = 0;
            
            for(let line of lines) {
                line = line.trim();
                if(!line) continue;
                // 格式：1.文字描述：url链接 或 文字描述 url链接
                // 简单解析：找最后一个 http 开始的位置
                const urlIndex = line.indexOf('http');
                if(urlIndex === -1) continue;
                
                const url = line.substring(urlIndex).trim();
                let desc = line.substring(0, urlIndex).trim();
                // 去掉前面的序号 "1." 和冒号
                desc = desc.replace(/^\d+[\.\:：\s]*/, '').replace(/[\:：\s]+$/, '');
                
                const sticker = { id: Date.now() + count, url: url, desc: desc };
                await saveDataToDB('stickers', sticker);
                savedStickers.push(sticker);
                count++;
            }
            
            closeBatchImportModal();
            closeStickerImportTypeModal();
            renderStickerGrid();
        }

        // 5. 本地上传
        function handleStickerFile(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    tempLocalStickerBase64 = e.target.result;
                    openLocalStickerModal();
                }
                reader.readAsDataURL(input.files[0]);
            }
            input.value = '';
        }
        function openLocalStickerModal() {
            document.getElementById('modalStickerLocalConfirm').classList.add('show');
            document.getElementById('stickerLocalPreview').src = tempLocalStickerBase64;
            document.getElementById('inputLocalStickerDesc').value = '';
        }
        function closeLocalStickerModal() {
            document.getElementById('modalStickerLocalConfirm').classList.remove('show');
        }
        async function saveLocalSticker() {
            const desc = document.getElementById('inputLocalStickerDesc').value;
            const sticker = { id: Date.now(), url: tempLocalStickerBase64, desc: desc };
            await saveDataToDB('stickers', sticker);
            savedStickers.push(sticker);
            closeLocalStickerModal();
            renderStickerGrid();
        }

        // 6. 删除逻辑
        function toggleStickerDeleteMode() {
            isStickerDeleteMode = !isStickerDeleteMode;
            selectedStickersToDelete.clear();
            updateStickerModalUI();
            renderStickerGrid();
        }
        
        function openDeleteStickersConfirm() {
            if(selectedStickersToDelete.size === 0) return;
            document.getElementById('modalDeleteStickersConfirm').classList.add('show');
        }
        
        function closeDeleteStickersConfirm() {
            document.getElementById('modalDeleteStickersConfirm').classList.remove('show');
        }
        
        async function performDeleteStickers() {
            const ids = Array.from(selectedStickersToDelete);
            for(let id of ids) {
                await deleteDataFromDB('stickers', id);
            }
            savedStickers = savedStickers.filter(s => !selectedStickersToDelete.has(s.id));
            
            closeDeleteStickersConfirm();
            toggleStickerDeleteMode(); // 退出删除模式
// 修改：显示成功弹窗，并确保遮罩层是显示的
            document.getElementById('modalOverlay').classList.add('show');
            showSuccessModal();
        }
        async function saveContextLimit() {
            if(!currentChatRole) return;
            let val = parseInt(document.getElementById('inputContextLimit').value);
            
            // 数据验证：1-5000
            if (isNaN(val) || val < 1) val = 1;
            if (val > 5000) val = 5000;
            
            // 更新输入框显示规范化后的数值
            document.getElementById('inputContextLimit').value = val;
            
            currentChatRole.contextLimit = val;
            await saveDataToDB('roles', currentChatRole);
            // 这里不弹窗提示，体验会更流畅，类似iOS设置
        }
        // 核心修复：确保加载顺序
        window.onload = function() {
            initDB().then(() => { loadDataFromDB(); });
            loadApiSettings();
            loadMeCardSettings();
            // 必须最后加载桌面设置，这样才能覆盖掉初始化的变量
            loadDesktopSettings(); 
            
            // 移除原本写在底部的 analyzeWallpaper() 调用，
            // 因为 loadDesktopSettings -> setWallpaper 内部会自动调用它
        };

        // 移除原本的 window.addEventListener('resize', ...) 之后的 analyzeWallpaper();
        window.addEventListener('resize', () => { setTimeout(() => analyzeWallpaper(), 300); });
    </script>
</body>
</html>
